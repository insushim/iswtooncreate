import{j as e,m as J,A as ns}from"./ui-D_LkVF2r.js";import{r as X,e as is,u as os}from"./vendor-Vqvh67Lm.js";import{B as E}from"./Button-C3O7gUUW.js";import{u as We,c as Le,L as Ge,d as rs}from"./index-BttAVUSQ.js";import{D as He,p as Fe}from"./parseJsonResponse-BC4W7KvA.js";import{g as Ae,C as Ee}from"./GeminiService-CuSaiY5Y.js";import"./storage-BBQgdv-R.js";import"./ai-BpRkNtKl.js";const qe=({tabs:s,activeTab:g,onChange:t,variant:r="default",size:u="md",fullWidth:o=!1,className:h=""})=>{const m={sm:"px-3 py-1.5 text-sm gap-1.5",md:"px-4 py-2 text-base gap-2",lg:"px-5 py-2.5 text-lg gap-2.5"};return(()=>{switch(r){case"pills":return e.jsx("div",{className:`flex gap-2 ${o?"w-full":""} ${h}`,children:s.map(n=>e.jsxs("button",{onClick:()=>!n.disabled&&t(n.id),disabled:n.disabled,className:`
                  flex items-center ${m[u]} rounded-lg
                  font-medium transition-all duration-200
                  ${o?"flex-1 justify-center":""}
                  ${n.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer"}
                  ${g===n.id?"bg-purple-600 text-white":"bg-gray-700 text-gray-400 hover:text-white hover:bg-gray-600"}
                `,children:[n.icon,n.label]},n.id))});case"underline":return e.jsx("div",{className:`flex border-b border-gray-700 ${o?"w-full":""} ${h}`,children:s.map(n=>e.jsxs("button",{onClick:()=>!n.disabled&&t(n.id),disabled:n.disabled,className:`
                  relative flex items-center ${m[u]}
                  font-medium transition-colors duration-200
                  ${o?"flex-1 justify-center":""}
                  ${n.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer"}
                  ${g===n.id?"text-purple-400":"text-gray-400 hover:text-white"}
                `,children:[n.icon,n.label,g===n.id&&e.jsx(J.div,{layoutId:"underline",className:"absolute bottom-0 left-0 right-0 h-0.5 bg-purple-500"})]},n.id))});default:return e.jsx("div",{className:`
              flex bg-gray-800 rounded-lg p-1
              ${o?"w-full":"inline-flex"}
              ${h}
            `,children:s.map(n=>e.jsxs("button",{onClick:()=>!n.disabled&&t(n.id),disabled:n.disabled,className:`
                  relative flex items-center ${m[u]} rounded-md
                  font-medium transition-all duration-200
                  ${o?"flex-1 justify-center":""}
                  ${n.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer"}
                  ${g===n.id?"text-white":"text-gray-400 hover:text-white"}
                `,children:[g===n.id&&e.jsx(J.div,{layoutId:"activeTab",className:"absolute inset-0 bg-gray-700 rounded-md",transition:{type:"spring",stiffness:500,damping:30}}),e.jsxs("span",{className:"relative z-10 flex items-center gap-2",children:[n.icon,n.label]})]},n.id))})}})()};async function ls(s,g){const{text:t,fontSize:r=26,fontFamily:u="'Noto Sans KR', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif",maxWidth:o=400,bubbleStyle:h="normal"}=g;return t.trim()?new Promise((m,C)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{const y=document.createElement("canvas").getContext("2d");if(!y){C(new Error("Canvas context not available"));return}y.font=`bold ${r}px ${u}`;const de=cs(y,t,o),Q=r*1.5,fe=de.length*Q,D=20,O=fe+D*2,K=document.createElement("canvas"),b=K.getContext("2d");if(!b){C(new Error("Canvas context not available"));return}K.width=n.width,K.height=n.height+O,b.fillStyle="#ffffff",b.fillRect(0,0,K.width,O),b.strokeStyle="#e0e0e0",b.lineWidth=1,b.beginPath(),b.moveTo(0,O),b.lineTo(K.width,O),b.stroke(),b.drawImage(n,0,O),b.font=`bold ${r}px ${u}`,b.textAlign="center",b.textBaseline="top",h==="shout"?b.fillStyle="#d32f2f":h==="thought"?b.fillStyle="#666666":b.fillStyle="#1a1a1a";const ee=D;de.forEach((ae,i)=>{b.fillText(ae,K.width/2,ee+i*Q)}),m(K.toDataURL("image/png"))},n.onerror=()=>{C(new Error("Failed to load image"))},n.src=s}):s}function cs(s,g,t){const r=[],u=g.split(/(\s+)/);let o="";for(const h of u){if(!h)continue;const m=o+h;if(s.measureText(m).width>t&&o.length>0){if(r.push(o.trim()),o=h,s.measureText(h).width>t){const n=h.split("");o="";for(const f of n){const y=o+f;s.measureText(y).width>t&&o.length>0?(r.push(o),o=f):o=y}}}else o=m}return o.trim()&&r.push(o.trim()),r}const ds=[{value:"full",label:"ì „ì²´"},{value:"large",label:"ëŒ€í˜•"},{value:"medium",label:"ì¤‘í˜•"},{value:"small",label:"ì†Œí˜•"},{value:"wide",label:"ê°€ë¡œí˜•"},{value:"tall",label:"ì„¸ë¡œí˜•"}],ms=[{value:"close-up",label:"í´ë¡œì¦ˆì—…"},{value:"medium-shot",label:"ë¯¸ë””ì—„ìƒ·"},{value:"wide-shot",label:"ì™€ì´ë“œìƒ·"},{value:"extreme-close-up",label:"ìµìŠ¤íŠ¸ë¦¼ í´ë¡œì¦ˆì—…"},{value:"bird-eye",label:"ë²„ë“œì•„ì´"},{value:"worm-eye",label:"ì›œì•„ì´"},{value:"dutch-angle",label:"ë”ì¹˜ì•µê¸€"},{value:"over-shoulder",label:"ì˜¤ë²„ìˆ„ë”"},{value:"pov",label:"POV"}],gs=({panel:s,episodeId:g,onUpdate:t})=>{var K,b,ee,ae;const[r,u]=X.useState(!1),[o,h]=X.useState(null),[m,C]=X.useState(""),{currentProject:n}=We(),{addToast:f}=Le(),y=async(i="preview")=>{var S,ne,be,ve,we,ye,je,Ne,ie,me,ge,ke,$e,a,w,j;if(n){u(!0);try{const k=n.episodes.find(N=>N.panels.some(d=>d.id===s.id)),G=(k==null?void 0:k.panels.findIndex(N=>N.id===s.id))??-1;let he="";if(k&&G>0){const N=Math.max(0,G-5),d=k.panels.slice(N,G);d.length>0&&(he=`

PREVIOUS PANELS CONTEXT (maintain visual consistency with these):
${d.map((R,xe)=>{var ce;const le=R.characters.map(x=>x.characterName).join(", ");return`Panel ${N+xe+1}: ${((ce=R.composition)==null?void 0:ce.slice(0,100))||"no description"}${le?` [Characters: ${le}]`:""} [Camera: ${R.cameraAngle}] [Mood: ${R.mood||"neutral"}] [Lighting: ${R.lighting}]`}).join(`
`)}`)}const oe=s.composition||((S=s.background)==null?void 0:S.description)||"",T=n.worldBuilding,B=(T==null?void 0:T.era)||"",z=(T==null?void 0:T.setting)||"",V=/í˜„ëŒ€|modern|ì‚¬ë¬´ì‹¤|office|ì•„íŒŒíŠ¸|apartment|ë„ì‹œ|city|ìŠ¤ë§ˆíŠ¸í°|ì»´í“¨í„°|ë…¸íŠ¸ë¶|ë¹Œë”©|building|í•™êµ|school|ì¹´íŽ˜|cafe|ë²„ìŠ¤|bus|ì§€í•˜ì² |subway|ë³‘ì›|hospital/i.test(oe),c=/ê³ ëŒ€|ancient|ê³ êµ¬ë ¤|ì‚¼êµ­|ì¡°ì„ |ê³ ë ¤|í•œë³µ|ì „í†µ|ê¶ê¶|palace|ì„±ê³½|castle|ì´ˆê°€|ì›€ë§‰|í•œì˜¥|hanok/i.test(oe),U=/í˜„ëŒ€|modern|ì‚¬ë¬´ì‹¤|office|ì•„íŒŒíŠ¸|apartment|ë„ì‹œ|city|ìŠ¤ë§ˆíŠ¸í°|ì»´í“¨í„°|ë…¸íŠ¸ë¶/i.test(m),Y=/ê³ ëŒ€|ancient|ê³ êµ¬ë ¤|ì‚¼êµ­|ì¡°ì„ |ê³ ë ¤|í•œë³µ|ì „í†µ/i.test(m);let v="",l="",p=!1;V?(v="modern contemporary Korean setting, current day Seoul, modern buildings, urban environment",l="modern Korean fashion, casual modern clothing",p=!1,console.log("[PanelEditor] Scene description requests modern setting - highest priority")):c?(v="ancient Korean historical setting, traditional architecture",l="traditional Korean hanbok",p=!0,console.log("[PanelEditor] Scene description requests ancient setting - highest priority")):U?(v="modern contemporary Korean setting, current day Seoul, modern buildings, urban environment",l="modern Korean fashion, casual modern clothing",p=!1,console.log("[PanelEditor] Feedback requests modern setting - overriding worldbuilding")):Y?(v="ancient Korean historical setting, traditional architecture",l="traditional Korean hanbok",p=!0,console.log("[PanelEditor] Feedback requests ancient setting")):B.includes("ì² ê¸°")||B.includes("ê³ êµ¬ë ¤")||B.includes("ancient")||B.includes("ì‚¼êµ­")||z.includes("ì² ê¸°")||z.includes("ê³ êµ¬ë ¤")||z.includes("ì‚¼êµ­")?(v="ancient Korean Three Kingdoms period, traditional hanok architecture, wooden structures",l="ancient Korean hanbok, layered silk robes, traditional hair accessories",p=!0,console.log("[PanelEditor] Using worldbuilding era setting (ancient)")):B.includes("ì¡°ì„ ")||z.includes("ì¡°ì„ ")?(v="Joseon Dynasty Korea, traditional hanok, paper windows",l="Joseon era hanbok",p=!0,console.log("[PanelEditor] Using worldbuilding era setting (Joseon)")):B.includes("ê³ ë ¤")||z.includes("ê³ ë ¤")?(v="Goryeo Dynasty Korea, Buddhist temples, traditional architecture",l="Goryeo era traditional clothing",p=!0,console.log("[PanelEditor] Using worldbuilding era setting (Goryeo)")):(B.includes("í˜„ëŒ€")||B.includes("modern")||z.includes("í˜„ëŒ€"))&&(v="modern contemporary Korean setting, current day",l="modern Korean fashion",p=!1,console.log("[PanelEditor] Using worldbuilding era setting (modern)"));const M=p?`

CRITICAL ERA CONSISTENCY: This is a HISTORICAL setting. ABSOLUTELY NO modern elements allowed - no modern buildings, no electricity, no modern clothing, no glasses, no modern hairstyles. Everything must be period-accurate.`:"",I=s.characters.map(N=>{var A,R,xe,le,ce,x,De,Te,ze,Me,Re;const d=n.characters.find(Se=>Se.name===N.characterName||Se.koreanName===N.characterName);if(d){const Se=d.gender==="female"?"beautiful young Korean woman":d.gender==="male"?"handsome young Korean man":"Korean person",Ye=d.age||25,Ze=((A=d.appearance)==null?void 0:A.hairColor)||"black",_e=((R=d.appearance)==null?void 0:R.hairStyle)||"long",Xe=((xe=d.appearance)==null?void 0:xe.eyeColor)||"dark brown",Qe=((le=d.appearance)==null?void 0:le.bodyType)||"slim",Oe=((ce=d.appearance)==null?void 0:ce.height)||"",es=((x=d.appearance)==null?void 0:x.skinTone)||"fair",ss=((De=d.appearance)==null?void 0:De.faceShape)||"oval",ts=((Te=d.appearance)==null?void 0:Te.eyeShape)||"almond",Ke=((Me=(ze=d.appearance)==null?void 0:ze.distinguishingFeatures)==null?void 0:Me.join(", "))||"",Be=((Re=d.appearance)==null?void 0:Re.defaultOutfit)||"",Ie=Be||l||(p?"traditional Korean hanbok":"modern Korean clothing"),as=d.role==="protagonist"?`elegant ${Ie}, high quality fabric`:d.role==="antagonist"?`imposing ${Ie}, dark tones`:Ie;return`[CHARACTER: ${d.name}] ${Se}, exactly ${Ye} years old, MUST have ${Ze} ${_e} hair, ${Xe} ${ts} eyes, ${es} skin, ${ss} face, ${Qe} body${Oe?`, ${Oe}`:""}, wearing ${as}${Ke?`. Distinctive features: ${Ke}`:""}. CRITICAL: Keep this character's face and appearance EXACTLY consistent with reference image provided.`}return p?"Korean person in traditional hanbok, period-accurate clothing":"Korean person in modern clothing"}).join(`
`),$=((be=(ne=s.dialogues)==null?void 0:ne[0])==null?void 0:be.text)||"",L=s.mood||"peaceful",P=s.lighting||"natural",H=s.size||"medium",F=s.cameraAngle||"medium-shot",Z={natural:"bright natural daylight, clear illumination",sunset:"warm golden hour lighting, orange and pink tones",night:"dark nighttime atmosphere with moonlight, blue shadows",indoor:"soft indoor artificial lighting, warm ambient",dramatic:"high contrast dramatic lighting, deep shadows, strong highlights",soft:"soft diffused lighting, gentle shadows",backlight:"strong backlight creating silhouette effect, rim lighting",neon:"colorful neon glow, cyberpunk atmosphere"},se={happy:"bright cheerful atmosphere, warm colors",sad:"melancholic mood, muted colors, somber tone",angry:"intense aggressive mood, sharp contrasts",romantic:"soft romantic atmosphere, warm pink tones",tense:"suspenseful tension, dramatic shadows",mysterious:"enigmatic mysterious mood, dark atmosphere",comedic:"light humorous tone, exaggerated expressions",peaceful:"calm serene atmosphere, gentle lighting",dramatic:"intense dramatic mood, high contrast",nostalgic:"warm nostalgic feeling, sepia tones"},ue={"close-up":"close-up shot focusing on face and expression","extreme-close-up":"extreme close-up on eyes or specific detail","medium-shot":"medium shot showing upper body","wide-shot":"wide establishing shot showing full scene with background","bird-eye":"bird's eye view from above looking down","worm-eye":"low angle worm's eye view looking up","dutch-angle":"tilted dutch angle creating unease","over-shoulder":"over the shoulder perspective",pov:"first person point of view"},_=Z[P]||"natural lighting",te=se[L]||"neutral atmosphere",pe=ue[F]||"medium shot",q=m?`

**CRITICAL USER FEEDBACK (MUST APPLY)**: ${m}
This feedback overrides any conflicting settings above.`:"",re=`Webtoon illustration, Korean manhwa style, clean detailed lineart, cel-shading, professional quality.

SCENE DESCRIPTION:
${oe}

VISUAL STYLE:
- Panel type: ${H} panel
- Camera: ${pe}
- Lighting: ${_}
- Mood/Atmosphere: ${te}

${I?`CHARACTERS IN SCENE:
${I}`:""}

${v?`SETTING/ERA: ${v}`:""}
${l?`COSTUME STYLE: ${l}`:""}
${M}
${he}
${q}

IMPORTANT: Maintain visual consistency with character appearances. Use ${pe} composition. Create ${te} with ${_}.`;console.log("[PanelEditor] Generated prompt:",re);const W=[];for(const N of s.characters){const d=n.characters.find(A=>A.name===N.characterName||A.koreanName===N.characterName);if(d){const A=((ve=d.referenceImages)==null?void 0:ve.filter(x=>x.type==="anchor"))||[];for(const x of A.slice(0,2))W.push(x.imageData);const R=((we=d.expressions)==null?void 0:we.filter(x=>x.imageData))||[];for(const x of R.slice(0,1))x.imageData&&W.push(x.imageData);const xe=((ye=d.poses)==null?void 0:ye.filter(x=>x.imageData))||[];for(const x of xe.slice(0,1))x.imageData&&W.push(x.imageData);const le=((je=d.outfits)==null?void 0:je.filter(x=>x.imageData))||[];for(const x of le.slice(0,1))x.imageData&&W.push(x.imageData);const ce=((Ne=d.referenceImages)==null?void 0:Ne.filter(x=>x.type!=="anchor"))||[];for(const x of ce.slice(0,1))W.push(x.imageData)}}if((ie=n.worldBuilding)!=null&&ie.mainLocations){const N=((ge=(me=s.background)==null?void 0:me.description)==null?void 0:ge.toLowerCase())||"";for(const d of n.worldBuilding.mainLocations)if(N.includes(d.name.toLowerCase())){for(const A of d.variations||[])if(A.generatedImage){W.push(A.generatedImage);break}}}if(k&&G>0){const N=Math.max(0,G-5),d=k.panels.slice(N,G);for(let A=d.length-1;A>=0;A--){const R=d[A];(ke=R.generatedImage)!=null&&ke.imageData&&W.length<12&&W.push(R.generatedImage.imageData)}}const Ve=W.slice(0,14),Ce=await Ae.generateImage(re,{resolution:i,styleAnchor:"",referenceImages:Ve,useCache:!1});let Pe=Ce.imageData;if($)try{const N=(a=($e=s.dialogues)==null?void 0:$e[0])==null?void 0:a.bubbleStyle,d=N==="thought"||N==="shout"?N:"normal";Pe=await ls(Ce.imageData,{text:$,position:((j=(w=s.dialogues)==null?void 0:w[0])==null?void 0:j.position)||{x:50,y:15},fontSize:28,bubbleStyle:d})}catch(N){console.error("Speech bubble rendering failed:",N)}i==="preview"?h(Pe):(t({generatedImage:{id:Date.now().toString(),resolution:i,imageData:Pe,promptUsed:re,generatedAt:new Date,fromCache:Ce.fromCache,cost:Ce.cost},status:"approved"}),h(null)),f({message:i==="preview"?"í”„ë¦¬ë·°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤":"ê³ í•´ìƒë„ ì´ë¯¸ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤",type:"success"})}catch(k){console.error("Image generation failed:",k),f({message:"ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤",type:"error"})}finally{u(!1)}}},de=()=>{o&&(t({generatedImage:{id:Date.now().toString(),resolution:"preview",imageData:o,promptUsed:s.visualPrompt,generatedAt:new Date,fromCache:!1,cost:.001},status:"approved"}),h(null))},Q=((b=(K=s.dialogues)==null?void 0:K[0])==null?void 0:b.text)||"",fe={"close-up":"í´ë¡œì¦ˆì—…","extreme-close-up":"ìµìŠ¤íŠ¸ë¦¼","medium-shot":"ë¯¸ë””ì—„","wide-shot":"ì™€ì´ë“œ","bird-eye":"ë²„ë“œì•„ì´","worm-eye":"ì›œì•„ì´","dutch-angle":"ë”ì¹˜","over-shoulder":"ì˜¤ë²„ìˆ„ë”",pov:"POV"},D={happy:"ë°ìŒ",sad:"ìŠ¬í””",angry:"ë¶„ë…¸",romantic:"ë¡œë§¨í‹±",tense:"ê¸´ìž¥",mysterious:"ë¯¸ìŠ¤í„°ë¦¬",comedic:"ì½”ë¯¹",peaceful:"í‰í™”",dramatic:"ê·¹ì ",nostalgic:"í–¥ìˆ˜"},O={natural:"ìžì—°ê´‘",sunset:"ì„ì–‘",night:"ì•¼ê°„",indoor:"ì‹¤ë‚´",dramatic:"ê·¹ì ",soft:"ì†Œí”„íŠ¸",backlight:"ì—­ê´‘",neon:"ë„¤ì˜¨"};return e.jsxs("div",{className:"bg-gray-800/50 rounded-xl border border-gray-700 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xl font-bold text-purple-400",children:["#",s.panelNumber]}),((ae=(ee=s.characters)==null?void 0:ee[0])==null?void 0:ae.characterName)&&e.jsx("span",{className:"text-sm text-gray-300",children:s.characters[0].characterName}),e.jsxs("div",{className:"flex gap-1.5",children:[e.jsx("span",{className:"px-2 py-0.5 bg-blue-500/20 text-blue-400 text-xs rounded-full",children:fe[s.cameraAngle]||s.cameraAngle}),s.mood&&e.jsx("span",{className:"px-2 py-0.5 bg-purple-500/20 text-purple-400 text-xs rounded-full",children:D[s.mood]||s.mood}),s.lighting&&e.jsx("span",{className:"px-2 py-0.5 bg-yellow-500/20 text-yellow-400 text-xs rounded-full",children:O[s.lighting]||s.lighting})]})]}),e.jsx(He,{options:ds,value:s.size,onChange:i=>t({size:i}),placeholder:"í¬ê¸°"})]}),e.jsxs("div",{className:"p-4",children:[Q&&e.jsxs("div",{className:"mb-4 p-3 bg-white/10 rounded-lg border-l-4 border-purple-500",children:[e.jsx("p",{className:"text-sm text-gray-400 mb-1",children:"ðŸ’¬ ëŒ€ì‚¬"}),e.jsxs("p",{className:"text-white text-lg font-medium",children:['"',Q,'"']})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"col-span-2",children:e.jsx("div",{className:"aspect-[4/3] bg-gray-900 rounded-lg overflow-hidden relative",children:e.jsx(ns,{mode:"wait",children:r?e.jsx(J.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ge,{size:"lg",className:"mx-auto mb-2"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"ì´ë¯¸ì§€ ìƒì„± ì¤‘..."})]})},"loading"):o?e.jsx(J.img,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},src:o,alt:"Preview",className:"w-full h-full object-contain bg-gray-950"},"preview"):s.generatedImage?e.jsx(J.img,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},src:s.generatedImage.imageData,alt:`Panel ${s.panelNumber}`,className:"w-full h-full object-contain bg-gray-950"},"generated"):e.jsx(J.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-5xl mb-3 block",children:"ðŸŽ¨"}),e.jsx("p",{className:"text-gray-400",children:"ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”"})]})},"empty")})})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(He,{label:"ì•µê¸€",options:ms,value:s.cameraAngle,onChange:i=>t({cameraAngle:i})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"ìž¥ë©´ ì„¤ëª…"}),e.jsx("textarea",{value:s.composition,onChange:i=>t({composition:i.target.value}),rows:3,className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm resize-none",placeholder:"ìž¥ë©´ ì„¤ëª…..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"ëŒ€ì‚¬ ìˆ˜ì •"}),e.jsx("textarea",{value:Q,onChange:i=>{var ne;const S=(ne=s.dialogues)!=null&&ne.length?[{...s.dialogues[0],text:i.target.value}]:[{id:`dlg-${Date.now()}`,text:i.target.value,type:"speech",bubbleStyle:"normal",position:{x:50,y:20},size:{width:200,height:80},fontSize:"medium"}];t({dialogues:S})},rows:2,className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm resize-none",placeholder:"ìºë¦­í„° ëŒ€ì‚¬..."})]})]})]}),e.jsxs("div",{className:"mt-4 p-3 bg-gray-700/50 rounded-lg",children:[e.jsx("label",{className:"block text-sm text-gray-300 mb-2",children:"âœï¸ ê·¸ë¦¼ ë³´ì™„ì  (ìž¬ìƒì„± ì‹œ ë°˜ì˜)"}),e.jsx("textarea",{value:m,onChange:i=>C(i.target.value),rows:2,className:"w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm resize-none mb-3",placeholder:"ì˜ˆ: í‘œì •ì„ ë” ë°ê²Œ, ë°°ê²½ì„ ì–´ë‘¡ê²Œ, ì•µê¸€ì„ í´ë¡œì¦ˆì—…ìœ¼ë¡œ... (ëŒ€ì‚¬ëŠ” ìœ„ 'ëŒ€ì‚¬ ìˆ˜ì •'ì— ìž…ë ¥)"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(E,{variant:"primary",onClick:()=>y("preview"),disabled:r,loading:r,children:s.generatedImage||o?"ðŸ”„ ìž¬ìƒì„±":"ðŸŽ¨ ì´ë¯¸ì§€ ìƒì„±"}),o&&e.jsxs(e.Fragment,{children:[e.jsx(E,{variant:"primary",onClick:de,size:"sm",children:"âœ“ ìŠ¹ì¸"}),e.jsx(E,{variant:"secondary",onClick:()=>h(null),size:"sm",children:"ì·¨ì†Œ"})]})]})]})]})]})},hs=({panels:s,selectedPanelId:g,onSelectPanel:t,onDeletePanel:r,onDeleteAllPanels:u})=>e.jsxs("div",{className:"bg-gray-800/50 rounded-xl border border-gray-700 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-white",children:"íƒ€ìž„ë¼ì¸"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-sm text-gray-400",children:[s.length," íŒ¨ë„"]}),s.length>0&&u&&e.jsx("button",{onClick:()=>{confirm("ëª¨ë“  íŒ¨ë„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")&&u()},className:"text-xs text-red-400 hover:text-red-300 px-2 py-1 rounded bg-red-500/10 hover:bg-red-500/20",children:"ì „ì²´ ì‚­ì œ"})]})]}),e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-2",children:[s.map(o=>e.jsxs(J.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:()=>t(o.id),className:`
              group relative flex-shrink-0 w-20 h-28 rounded-lg overflow-hidden border-2 transition-all
              ${g===o.id?"border-purple-500 ring-2 ring-purple-500/30":"border-gray-700 hover:border-gray-600"}
            `,children:[o.generatedImage?e.jsx("img",{src:o.generatedImage.imageData,alt:`Panel ${o.panelNumber}`,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-gray-900 flex items-center justify-center",children:e.jsx("span",{className:"text-gray-600 text-2xl",children:"ðŸŽ¨"})}),e.jsx("div",{className:"absolute top-1 left-1 w-5 h-5 rounded bg-black/60 flex items-center justify-center",children:e.jsx("span",{className:"text-white text-xs font-bold",children:o.panelNumber})}),r&&e.jsx("div",{onClick:h=>{h.stopPropagation(),confirm(`íŒ¨ë„ ${o.panelNumber}ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)&&r(o.id)},className:"absolute top-1 right-1 w-5 h-5 rounded bg-red-500/80 hover:bg-red-500 flex items-center justify-center cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("span",{className:"text-white text-xs",children:"âœ•"})}),e.jsx("div",{className:`absolute bottom-1 right-1 w-2 h-2 rounded-full ${o.status==="approved"?"bg-green-500":o.status==="preview"?"bg-yellow-500":"bg-gray-500"}`}),g===o.id&&e.jsx(J.div,{layoutId:"selectedPanel",className:"absolute inset-0 border-2 border-purple-500 rounded-lg"})]},o.id)),e.jsx("button",{className:"flex-shrink-0 w-20 h-28 rounded-lg border-2 border-dashed border-gray-700 hover:border-gray-600 flex items-center justify-center transition-colors",children:e.jsx("svg",{className:"w-6 h-6 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]})]}),us=({projectTitle:s,episodeTitle:g,onSave:t,onPreview:r,onExport:u})=>{const{viewMode:o,setViewMode:h,zoom:m,setZoom:C}=Le(),n=[{id:"edit",label:"íŽ¸ì§‘"},{id:"preview",label:"ë¯¸ë¦¬ë³´ê¸°"},{id:"split",label:"ë¶„í• "}];return e.jsx("div",{className:"bg-gray-800/80 backdrop-blur-sm border-b border-gray-700 px-4 py-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-white font-bold",children:s}),e.jsx("span",{className:"text-gray-400",children:"/"}),e.jsx("span",{className:"text-gray-300",children:g})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(qe,{tabs:n,activeTab:o,onChange:f=>h(f),variant:"pills",size:"sm"}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-gray-700 rounded-lg",children:[e.jsx("button",{onClick:()=>C(m-10),className:"text-gray-400 hover:text-white transition-colors",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),e.jsxs("span",{className:"text-white text-sm w-12 text-center",children:[m,"%"]}),e.jsx("button",{onClick:()=>C(m+10),className:"text-gray-400 hover:text-white transition-colors",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(E,{variant:"ghost",size:"sm",onClick:t,children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"})}),"ì €ìž¥"]}),e.jsxs(E,{variant:"ghost",size:"sm",onClick:r,children:[e.jsxs("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]}),"ë¯¸ë¦¬ë³´ê¸°"]}),e.jsxs(E,{variant:"primary",size:"sm",onClick:u,children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),"ë‚´ë³´ë‚´ê¸°"]})]})]})})};async function ps(s){const t=[...s].sort((n,f)=>n.panelNumber-f.panelNumber).filter(n=>{var f;return(f=n.generatedImage)==null?void 0:f.imageData});if(t.length===0)throw new Error("ë‚´ë³´ë‚¼ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");const r=await Promise.all(t.map(n=>xs(n.generatedImage.imageData))),u=Math.max(...r.map(n=>n.width)),o=r.reduce((n,f)=>n+f.height,0),h=document.createElement("canvas"),m=h.getContext("2d");if(!m)throw new Error("Canvas context not available");h.width=u,h.height=o,m.fillStyle="#ffffff",m.fillRect(0,0,h.width,h.height);let C=0;for(const n of r){const f=(u-n.width)/2;m.drawImage(n,f,C),C+=n.height}return h.toDataURL("image/png")}function xs(s){return new Promise((g,t)=>{const r=new Image;r.crossOrigin="anonymous",r.onload=()=>g(r),r.onerror=()=>t(new Error("Failed to load image")),r.src=s})}function Je(s,g){const t=document.createElement("a");t.href=s,t.download=g,document.body.appendChild(t),t.click(),document.body.removeChild(t)}async function fs(s){const g=await ps(s.panels),t=`${s.episodeNumber}í™”_${s.title||"episode"}.png`;Je(g,t)}function ys(s,g){var r;if(!((r=s.generatedImage)!=null&&r.imageData))throw new Error("ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");const t=`${g}í™”_íŒ¨ë„${s.panelNumber}.png`;Je(s.generatedImage.imageData,t)}async function Ue(s){const t=[...s.panels].sort((r,u)=>r.panelNumber-u.panelNumber).filter(r=>{var u;return(u=r.generatedImage)==null?void 0:u.imageData});for(const r of t)ys(r,s.episodeNumber),await new Promise(u=>setTimeout(u,300))}async function bs(s,g){const{format:t}=g;switch(t){case"long-image":await fs(s);break;case"individual":await Ue(s);break;case"zip":await Ue(s);break;default:throw new Error("ì§€ì›í•˜ì§€ ì•ŠëŠ” ë‚´ë³´ë‚´ê¸° í˜•ì‹ìž…ë‹ˆë‹¤.")}}const Ps=()=>{const{projectId:s}=is(),g=os(),{currentProject:t,setCurrentProject:r,updatePanel:u,addPanel:o,deletePanel:h}=We(),{selectedEpisodeId:m,setSelectedEpisode:C,selectedPanelId:n,setSelectedPanel:f,addToast:y}=Le(),{user:de}=rs(),[Q,fe]=X.useState(!0),[D,O]=X.useState(!1),[K,b]=X.useState(!1),[ee,ae]=X.useState([]);X.useEffect(()=>{(async()=>{s&&(await r(s),fe(!1))})()},[s,r]),X.useEffect(()=>{t!=null&&t.episodes.length&&!m&&C(t.episodes[0].id)},[t,m,C]);const i=t==null?void 0:t.episodes.find(a=>a.id===m),S=i==null?void 0:i.panels.find(a=>a.id===n),ne=async(a,w)=>{m&&(await u(m,a,w),y({message:"íŒ¨ë„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤",type:"success"}))},be=async()=>{var a,w;if(!(!i||!t)){O(!0),y({message:"íŒ¨ë„ì„ ìƒì„±í•˜ê³  ìžˆìŠµë‹ˆë‹¤...",type:"info"});try{const j=t.worldBuilding,k=(j==null?void 0:j.era)||"ê³ ëŒ€ í•œêµ­",G=(j==null?void 0:j.setting)||"ì—­ì‚¬ë¬¼",he=t.characters.map(c=>{var I,$,L,P,H,F;const U=c.gender==="female"?"woman":c.gender==="male"?"man":"person",Y=((I=c.appearance)==null?void 0:I.hairColor)||"black",v=(($=c.appearance)==null?void 0:$.hairStyle)||"long",l=((L=c.appearance)==null?void 0:L.eyeColor)||"dark brown",p=((P=c.appearance)==null?void 0:P.defaultOutfit)||"",M=((F=(H=c.appearance)==null?void 0:H.distinguishingFeatures)==null?void 0:F.join(", "))||"";return`${c.name}: ${U}, ${Y} ${v} hair, ${l} eyes${p?`, wearing ${p}`:""}${M?`, features: ${M}`:""}`}).join(`
`),oe=((a=j==null?void 0:j.mainLocations)==null?void 0:a.map(c=>`${c.name}: ${c.description||""}`).join(`
`))||"",T=70,B=`ì›¹íˆ° ${i.episodeNumber}í™” íŒ¨ë„ ${T}ê°œ ìƒì„±. JSON ì¶œë ¥.

ìŠ¤í† ë¦¬: ${i.summary}
ë°°ê²½: ${k}, ${G}
ì£¼ìš” ì´ë²¤íŠ¸: ${((w=i.keyEvents)==null?void 0:w.join(", "))||""}

ìºë¦­í„°:
${he}

ìž¥ì†Œ:
${oe}

âš ï¸âš ï¸âš ï¸ ë§¤ìš° ì¤‘ìš” - ë°˜ë“œì‹œ ì´ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥ âš ï¸âš ï¸âš ï¸

{"panels":[
{"n":1,"size":"full","camera":"wide-shot","mood":"mysterious","lighting":"night","img":"[LOCATION: ì–´ë‘ìš´ ì‚¬ë¬´ì‹¤, ëª¨ë‹ˆí„° ë¶ˆë¹›ë§Œ ë¹„ì¹¨] [CHARACTER: í•˜ëŠ˜, 20ëŒ€ ì—¬ì„±, ê²€ì€ ê¸´ ë¨¸ë¦¬ ííŠ¸ëŸ¬ì§, ë‹¤í¬ì„œí´, í›„ë“œí‹°] [ATMOSPHERE: ìƒˆë²½ 3ì‹œ, ì°¨ê°€ìš´ ëª¨ë‹ˆí„° ë¹›]","dialog":""},
{"n":2,"size":"small","camera":"extreme-close-up","mood":"tense","lighting":"dramatic","img":"[FOCUS: ë””ì§€í„¸ ì‹œê³„ 03:42 AM]","dialog":""},
{"n":3,"size":"medium","camera":"medium-shot","mood":"sad","lighting":"indoor","img":"[CHARACTER: í•˜ëŠ˜, ì§€ì¹œ í‘œì •ìœ¼ë¡œ í‚¤ë³´ë“œ íƒ€ì´í•‘]","dialog":"ì  ìž¥..."}
]}

ðŸ“Œ ê° íŒ¨ë„ì— ë°˜ë“œì‹œ í¬í•¨í•  6ê°œ í•„ë“œ:
- "n": íŒ¨ë„ ë²ˆí˜¸ (1-${T})
- "size": full/large/medium/small/wide ì¤‘ í•˜ë‚˜
- "camera": close-up/extreme-close-up/medium-shot/wide-shot/bird-eye/worm-eye/dutch-angle/over-shoulder ì¤‘ í•˜ë‚˜
- "mood": happy/sad/angry/romantic/tense/mysterious/comedic/peaceful/dramatic/nostalgic ì¤‘ í•˜ë‚˜
- "lighting": natural/sunset/night/indoor/dramatic/soft/backlight/neon ì¤‘ í•˜ë‚˜
- "img": ì˜ì–´ë¡œ ìƒì„¸í•œ ìž¥ë©´ ì„¤ëª…
- "dialog": í•œêµ­ì–´ ëŒ€ì‚¬ ë˜ëŠ” ""

ðŸ“Š ë‹¤ì–‘í•˜ê²Œ ì‚¬ìš©í•´ì•¼ í•  ë¹„ìœ¨:
- size: full 10ê°œ, large 15ê°œ, medium 30ê°œ, small 15ê°œ
- camera: ë‹¤ì–‘í•œ ì•µê¸€ì„ ì”¬ì— ë§žê²Œ ì‚¬ìš©
- mood: ìž¥ë©´ ê°ì •ì— ë§žê²Œ ë³€ê²½
- lighting: ì‹œê°„ëŒ€ì™€ ë¶„ìœ„ê¸°ì— ë§žê²Œ ë³€ê²½

ðŸŽ¨ img í•„ë“œ ìž‘ì„±ë²• (ì˜ì–´ë¡œ):
[LOCATION: ìž¥ì†Œ ìƒì„¸ - ê±´ë¬¼, ê°€êµ¬, ì†Œí’ˆ]
[CHARACTER: ì´ë¦„, ì„±ë³„, ë‚˜ì´, ë¨¸ë¦¬ìƒ‰+ìŠ¤íƒ€ì¼, ëˆˆìƒ‰, í‘œì •, í¬ì¦ˆ, ì˜ìƒ ìƒì„¸]
[ATMOSPHERE: ì¡°ëª… ë°©í–¥, ê·¸ë¦¼ìž, ë‚ ì”¨]

ê·œì¹™:
1. ì •í™•ížˆ ${T}ê°œ íŒ¨ë„ ìƒì„± (1-${T})
2. ëª¨ë“  íŒ¨ë„ì— size, camera, mood, lighting í•„ë“œ í•„ìˆ˜!
3. imgëŠ” ì˜ì–´ë¡œë§Œ, dialogëŠ” í•œêµ­ì–´ë¡œë§Œ
4. ëŒ€ì‚¬ ì—†ëŠ” ìž¥ë©´ì€ dialogë¥¼ "" ë¡œ
5. JSONë§Œ ì¶œë ¥, { ë¡œ ì‹œìž‘`,z=await Ae.generateText(B,{temperature:.8,maxTokens:32e3,useCache:!1});console.log("[AI Response Raw]:",z);const V=Fe(z);if(console.log("[Parsed Result]:",JSON.stringify(V,null,2)),!V.panels||V.panels.length===0)throw new Error("íŒ¨ë„ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");for(const c of V.panels){console.log("[Panel Data]:",JSON.stringify(c,null,2));const U=c.n||c.panelNumber||1,Y=c.img||c.sceneDescription||"";let v=c.dialog??c.dialogue??c.talk??c.speech??c.text??"";console.log(`[Panel ${U}] Dialog field:`,c.dialog,"| Dialogue field:",c.dialogue,"| Final:",v);const p=!/[ê°€-íž£]/.test(v)&&/^[a-zA-Z\s,.\-'":;!?]+$/.test(v);v&&p&&(console.log(`[Panel ${U}] Filtered out English description:`,v),v="");const M=c.who||c.character||"",I=c.size||"medium",$=c.camera||"medium-shot",L=c.mood||"peaceful",P=c.lighting||"natural";console.log(`[Panel ${U}] AI Values - size: ${c.size}, camera: ${c.camera}, mood: ${c.mood}, lighting: ${c.lighting}`);const H=["full","large","medium","small","wide","tall"],F=["close-up","medium-shot","wide-shot","extreme-close-up","bird-eye","worm-eye","dutch-angle","over-shoulder","pov"],Z=["happy","sad","angry","romantic","tense","mysterious","comedic","peaceful","dramatic","nostalgic"],se=["natural","sunset","night","indoor","dramatic","soft","backlight","neon"],ue=H.includes(I)?I:"medium",_=F.includes($)?$:"medium-shot",te=Z.includes(L)?L:"peaceful",pe=se.includes(P)?P:"natural";let q="afternoon";P==="night"?q="night":P==="sunset"?q="evening":P==="soft"&&(q="morning");const re={episodeId:i.id,panelNumber:U,size:ue,cameraAngle:_,composition:Y,characters:M?[{characterId:"",characterName:M,position:{x:50,y:50},scale:1,expression:"neutral",pose:"standing",action:"",facing:"front",layer:1}]:[],background:{locationName:"",description:Y,timeOfDay:q,weather:"",mood:te,focusPoint:"",depth:ue==="wide"||_==="wide-shot"?"deep":_==="close-up"||_==="extreme-close-up"?"shallow":"medium"},dialogues:v?[{id:`dlg-${Date.now()}-${U}`,text:v,type:"speech",bubbleStyle:"normal",position:{x:50,y:20},size:{width:200,height:80},fontSize:"medium"}]:[],sfx:[],mood:te,lighting:pe,visualPrompt:Y,status:"pending"};await o(i.id,re)}await r(s),y({message:`${V.panels.length}ê°œ íŒ¨ë„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`,type:"success"})}catch(j){console.error("Panel generation failed:",j),y({message:"íŒ¨ë„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",type:"error"})}finally{O(!1)}}},ve=async a=>{m&&(await h(m,a),f(null),y({message:"íŒ¨ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤",type:"success"}))},we=async()=>{if(i){for(const a of i.panels)await h(i.id,a.id);f(null),y({message:"ëª¨ë“  íŒ¨ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤",type:"success"})}},ye=()=>{if(!i)return[];const a=70,w=new Set(i.panels.map(k=>k.panelNumber)),j=[];for(let k=1;k<=a;k++)w.has(k)||j.push(k);return j},je=()=>{const a=ye();a.length>0?(ae(a),b(!0)):y({message:"ë¹ ì§„ íŒ¨ë„ì´ ì—†ìŠµë‹ˆë‹¤!",type:"success"})},Ne=async a=>{if(!(!i||!t||a.length===0)){O(!0),b(!1),y({message:`${a.length}ê°œ ë¹ ì§„ íŒ¨ë„ì„ ìƒì„±í•˜ê³  ìžˆìŠµë‹ˆë‹¤...`,type:"info"});try{const w=t.worldBuilding,j=(w==null?void 0:w.era)||"ê³ ëŒ€ í•œêµ­",k=(w==null?void 0:w.setting)||"ì—­ì‚¬ë¬¼",G=t.characters.map(l=>{var P,H,F,Z;const p=l.gender==="female"?"woman":l.gender==="male"?"man":"person",M=((P=l.appearance)==null?void 0:P.hairColor)||"black",I=((H=l.appearance)==null?void 0:H.hairStyle)||"long",$=((F=l.appearance)==null?void 0:F.eyeColor)||"dark brown",L=((Z=l.appearance)==null?void 0:Z.defaultOutfit)||"";return`${l.name}: ${p}, ${M} ${I} hair, ${$} eyes${L?`, wearing ${L}`:""}`}).join(`
`),he=l=>{var $,L;const p=i.panels.find(P=>P.panelNumber===l-1),M=i.panels.find(P=>P.panelNumber===l+1);let I="";return p&&(I+=`Previous panel ${l-1}: ${(($=p.composition)==null?void 0:$.slice(0,100))||"no description"}
`),M&&(I+=`Next panel ${l+1}: ${((L=M.composition)==null?void 0:L.slice(0,100))||"no description"}
`),I},oe=a.map(l=>`Panel ${l} context:
${he(l)}`).join(`

`),T=`ë¹ ì§„ íŒ¨ë„ë§Œ ìƒì„±. JSON ì¶œë ¥.

ìŠ¤í† ë¦¬: ${i.summary}
ë°°ê²½: ${j}, ${k}

ìºë¦­í„°:
${G}

ìƒì„±í•  íŒ¨ë„ ë²ˆí˜¸: ${a.join(", ")}

ì•žë’¤ ë¬¸ë§¥:
${oe}

âš ï¸âš ï¸âš ï¸ ë°˜ë“œì‹œ ì´ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥ âš ï¸âš ï¸âš ï¸

{"panels":[
{"n":${a[0]},"size":"medium","camera":"close-up","mood":"tense","lighting":"dramatic","img":"[LOCATION: ìž¥ì†Œ] [CHARACTER: ì´ë¦„, ë¨¸ë¦¬ìƒ‰, í‘œì •, ì˜ìƒ] [ATMOSPHERE: ì¡°ëª…]","dialog":"í•œêµ­ì–´ ëŒ€ì‚¬"}
]}

ðŸ“Œ ê° íŒ¨ë„ì— ë°˜ë“œì‹œ í¬í•¨í•  6ê°œ í•„ë“œ:
- "n": íŒ¨ë„ ë²ˆí˜¸
- "size": full/large/medium/small/wide ì¤‘ í•˜ë‚˜
- "camera": close-up/extreme-close-up/medium-shot/wide-shot/bird-eye/worm-eye/dutch-angle/over-shoulder ì¤‘ í•˜ë‚˜
- "mood": happy/sad/angry/romantic/tense/mysterious/comedic/peaceful/dramatic/nostalgic ì¤‘ í•˜ë‚˜
- "lighting": natural/sunset/night/indoor/dramatic/soft/backlight/neon ì¤‘ í•˜ë‚˜
- "img": ì˜ì–´ë¡œ ìž¥ë©´ ì„¤ëª…
- "dialog": í•œêµ­ì–´ ëŒ€ì‚¬ ë˜ëŠ” ""

ê·œì¹™:
1. ì •í™•ížˆ ${a.join(", ")} ë²ˆ íŒ¨ë„ë§Œ ìƒì„± (${a.length}ê°œ)
2. ëª¨ë“  íŒ¨ë„ì— size, camera, mood, lighting í•„ë“œ í•„ìˆ˜!
3. ì•žë’¤ íŒ¨ë„ê³¼ ìžì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°
4. JSONë§Œ ì¶œë ¥`,B=await Ae.generateText(T,{temperature:.7,maxTokens:16e3,useCache:!1}),z=Fe(B);if(!z.panels||z.panels.length===0)throw new Error("íŒ¨ë„ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");const V=["full","large","medium","small","wide","tall"],c=["close-up","medium-shot","wide-shot","extreme-close-up","bird-eye","worm-eye","dutch-angle","over-shoulder","pov"],U=["happy","sad","angry","romantic","tense","mysterious","comedic","peaceful","dramatic","nostalgic"],Y=["natural","sunset","night","indoor","dramatic","soft","backlight","neon"];let v=0;for(const l of z.panels){const p=l.n||l.panelNumber;if(!a.includes(p)){console.log(`[Missing Panel] Skipping panel ${p} - not in requested list`);continue}if(i.panels.some(W=>W.panelNumber===p)){console.log(`[Missing Panel] Panel ${p} already exists, skipping`);continue}const I=l.img||l.sceneDescription||"";let $=l.dialog??l.dialogue??"";const P=!/[ê°€-íž£]/.test($)&&/^[a-zA-Z\s,.\-'":;!?]+$/.test($);$&&P&&($="");const H=l.size||"medium",F=l.camera||"medium-shot",Z=l.mood||"peaceful",se=l.lighting||"natural",ue=V.includes(H)?H:"medium",_=c.includes(F)?F:"medium-shot",te=U.includes(Z)?Z:"peaceful",pe=Y.includes(se)?se:"natural";let q="afternoon";se==="night"?q="night":se==="sunset"&&(q="evening");const re={episodeId:i.id,panelNumber:p,size:ue,cameraAngle:_,composition:I,characters:[],background:{locationName:"",description:I,timeOfDay:q,weather:"",mood:te,focusPoint:"",depth:"medium"},dialogues:$?[{id:`dlg-${Date.now()}-${p}`,text:$,type:"speech",bubbleStyle:"normal",position:{x:50,y:20},size:{width:200,height:80},fontSize:"medium"}]:[],sfx:[],mood:te,lighting:pe,visualPrompt:I,status:"pending"};await o(i.id,re),v++}await r(s),y({message:`${v}ê°œ ë¹ ì§„ íŒ¨ë„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`,type:"success"})}catch(w){console.error("Missing panel generation failed:",w),y({message:"ë¹ ì§„ íŒ¨ë„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",type:"error"})}finally{O(!1)}}};if(Q)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsx(Ge,{size:"lg"})});if(!t)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs(Ee,{className:"text-center p-8",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4",children:"í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"}),e.jsx(E,{variant:"primary",onClick:()=>g("/dashboard"),children:"ëŒ€ì‹œë³´ë“œë¡œ ì´ë™"})]})});const ie=(t==null?void 0:t.episodes.findIndex(a=>a.id===m))??-1,me=ie>0,ge=ie<((t==null?void 0:t.episodes.length)??0)-1,ke=()=>{if(me&&t){const a=t.episodes[ie-1];C(a.id),a.panels.length>0?f(a.panels[0].id):f(null)}},$e=()=>{if(ge&&t){const a=t.episodes[ie+1];C(a.id),a.panels.length>0?f(a.panels[0].id):f(null)}};return e.jsxs("div",{className:"min-h-screen bg-gray-900 flex flex-col",children:[e.jsxs("div",{className:"bg-gray-800 border-b border-gray-700 px-4 py-2 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(E,{variant:"ghost",size:"sm",onClick:()=>g(`/create/${s}`),className:"text-gray-400 hover:text-white",children:[e.jsx("svg",{className:"w-5 h-5 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),"í”„ë¡œì íŠ¸ ì„¤ì •"]}),e.jsx("div",{className:"text-gray-400",children:"|"}),e.jsx("h1",{className:"text-white font-bold",children:t.title})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{variant:"ghost",size:"sm",onClick:ke,disabled:!me,className:me?"":"opacity-50 cursor-not-allowed",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsxs("div",{className:"bg-gray-700 rounded-lg px-4 py-2 min-w-[200px] text-center",children:[e.jsx("span",{className:"text-purple-400 font-bold",children:i?`${i.episodeNumber}í™”`:"ì—í”¼ì†Œë“œ ì„ íƒ"}),i&&e.jsxs("span",{className:"text-gray-400 ml-2 text-sm",children:["/ ",t.episodes.length,"í™”"]})]}),e.jsx(E,{variant:"ghost",size:"sm",onClick:$e,disabled:!ge,className:ge?"":"opacity-50 cursor-not-allowed",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]}),e.jsx("div",{className:"flex items-center gap-2",children:de?e.jsxs("div",{className:"flex items-center gap-2 text-green-400 text-sm",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"})}),e.jsx("span",{children:"ìžë™ ë™ê¸°í™” ì¤‘"})]}):e.jsxs("button",{onClick:()=>g("/settings"),className:"flex items-center gap-2 text-gray-400 hover:text-white text-sm transition-colors",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"})}),e.jsx("span",{children:"ë¡œê·¸ì¸í•˜ì—¬ ë™ê¸°í™”"})]})})]}),e.jsx(us,{projectTitle:t.title,episodeTitle:(i==null?void 0:i.title)||"ì—í”¼ì†Œë“œ ì„ íƒ",onSave:()=>y({message:"ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤ (ìžë™ ì €ìž¥ë¨)",type:"success"}),onPreview:()=>g(`/preview/${s}`),onExport:async()=>{if(!i){y({message:"ì—í”¼ì†Œë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”",type:"error"});return}if(i.panels.filter(w=>{var j;return(j=w.generatedImage)==null?void 0:j.imageData}).length===0){y({message:"ë‚´ë³´ë‚¼ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤",type:"error"});return}try{y({message:"ì´ë¯¸ì§€ë¥¼ ë³‘í•©í•˜ê³  ìžˆìŠµë‹ˆë‹¤...",type:"info"}),await bs(i,{format:"long-image"}),y({message:"ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!",type:"success"})}catch(w){console.error("Export failed:",w),y({message:"ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤",type:"error"})}}}),e.jsxs("div",{className:"flex-1 flex",children:[e.jsxs("div",{className:"w-64 bg-gray-800/50 border-r border-gray-700 p-4 overflow-y-auto",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"ì—í”¼ì†Œë“œ"}),e.jsx("div",{className:"space-y-2",children:t.episodes.length>0?t.episodes.map(a=>e.jsxs(J.button,{whileHover:{x:4},onClick:()=>{C(a.id),a.panels.length>0&&f(a.panels[0].id)},className:`w-full text-left p-3 rounded-lg transition-colors ${m===a.id?"bg-purple-600/30 border border-purple-500":"bg-gray-700/50 hover:bg-gray-700"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-white font-medium",children:[a.episodeNumber,"í™”"]}),e.jsxs("span",{className:"text-gray-400 text-sm",children:[a.panels.length," íŒ¨ë„"]})]}),e.jsx("p",{className:"text-gray-400 text-sm truncate mt-1",children:a.title})]},a.id)):e.jsxs("div",{className:"text-center text-gray-400 py-8",children:[e.jsx("p",{children:"ì—í”¼ì†Œë“œê°€ ì—†ìŠµë‹ˆë‹¤"}),e.jsx(E,{variant:"ghost",size:"sm",className:"mt-2",onClick:()=>{},children:"ì—í”¼ì†Œë“œ ì¶”ê°€"})]})}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"ìºë¦­í„°"}),e.jsx("div",{className:"space-y-2",children:t.characters.map(a=>e.jsxs("div",{className:"flex items-center gap-3 p-2 rounded-lg bg-gray-700/30",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-sm",children:a.gender==="female"?"ðŸ‘©":"ðŸ‘¨"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white text-sm font-medium",children:a.name}),e.jsx("p",{className:"text-gray-400 text-xs",children:a.role})]})]},a.id))})]})]}),e.jsx("div",{className:"flex-1 flex flex-col p-4 overflow-hidden",children:i?e.jsxs(e.Fragment,{children:[e.jsx(hs,{panels:i.panels,selectedPanelId:n,onSelectPanel:f,onDeletePanel:ve,onDeleteAllPanels:we}),e.jsxs("div",{className:"flex-1 mt-4 overflow-y-auto",children:[S?e.jsx(gs,{panel:S,episodeId:i.id,onUpdate:a=>ne(S.id,a)}):e.jsx(Ee,{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-4xl mb-4 block",children:"ðŸŽ¬"}),e.jsx("p",{className:"text-gray-400 mb-2",children:i.panels.length===0?"ì´ ì—í”¼ì†Œë“œì— íŒ¨ë„ì´ ì—†ìŠµë‹ˆë‹¤":"íŒ¨ë„ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ì¶”ê°€í•˜ì„¸ìš”"}),i.panels.length===0&&e.jsx("p",{className:"text-gray-500 text-sm mb-4",children:"AIê°€ ì—í”¼ì†Œë“œ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ íŒ¨ë„ì„ ìžë™ ìƒì„±í•©ë‹ˆë‹¤"}),e.jsx(E,{variant:"primary",className:"mt-4",onClick:be,disabled:D,loading:D,children:D?"AI íŒ¨ë„ ìƒì„± ì¤‘...":"AI íŒ¨ë„ ìžë™ ìƒì„±"})]})}),i.panels.length>0&&e.jsxs("div",{className:"mt-4 flex gap-2 justify-center",children:[e.jsx(E,{variant:"secondary",size:"sm",onClick:je,disabled:D,children:"ðŸ” ë¹ ì§„ íŒ¨ë„ í™•ì¸"}),e.jsxs(E,{variant:"secondary",size:"sm",onClick:()=>{const a=ye();a.length>0?(ae(a),b(!0)):y({message:"ì´ë¯¸ 70ê°œ íŒ¨ë„ì´ ëª¨ë‘ ìžˆìŠµë‹ˆë‹¤!",type:"success"})},disabled:D,loading:D,children:["âž• íŒ¨ë„ ì¶”ê°€ ìƒì„± (",70-((i==null?void 0:i.panels.length)||0),"ê°œ ë‚¨ìŒ)"]})]})]})]}):e.jsx(Ee,{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-4xl mb-4 block",children:"ðŸ“š"}),e.jsx("p",{className:"text-gray-400",children:"ì—í”¼ì†Œë“œë¥¼ ì„ íƒí•˜ì„¸ìš”"})]})})}),e.jsxs("div",{className:"w-72 bg-gray-800/50 border-l border-gray-700 p-4 overflow-y-auto",children:[e.jsx(qe,{tabs:[{id:"properties",label:"ì†ì„±"},{id:"dialogue",label:"ëŒ€ì‚¬"}],activeTab:"properties",onChange:()=>{},variant:"underline",fullWidth:!0}),e.jsx("div",{className:"mt-4",children:S?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"íŒ¨ë„ í¬ê¸°"}),e.jsx("p",{className:"text-white",children:{full:"ì „ì²´",large:"ëŒ€í˜•",medium:"ì¤‘í˜•",small:"ì†Œí˜•",wide:"ê°€ë¡œí˜•",tall:"ì„¸ë¡œí˜•",custom:"ì»¤ìŠ¤í…€"}[S.size]||S.size})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"ì¹´ë©”ë¼ ì•µê¸€"}),e.jsx("p",{className:"text-white",children:{"close-up":"í´ë¡œì¦ˆì—…","extreme-close-up":"ìµìŠ¤íŠ¸ë¦¼ í´ë¡œì¦ˆì—…","medium-shot":"ë¯¸ë””ì—„ìƒ·","wide-shot":"ì™€ì´ë“œìƒ·","bird-eye":"ë²„ë“œì•„ì´","worm-eye":"ì›œì•„ì´","dutch-angle":"ë”ì¹˜ì•µê¸€","over-shoulder":"ì˜¤ë²„ìˆ„ë”",pov:"POV"}[S.cameraAngle]||S.cameraAngle})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"ë¶„ìœ„ê¸°"}),e.jsx("p",{className:"text-white",children:{happy:"ë°ìŒ ðŸ˜Š",sad:"ìŠ¬í”” ðŸ˜¢",angry:"ë¶„ë…¸ ðŸ˜ ",romantic:"ë¡œë§¨í‹± ðŸ’•",tense:"ê¸´ìž¥ ðŸ˜°",mysterious:"ë¯¸ìŠ¤í„°ë¦¬ ðŸ”®",comedic:"ì½”ë¯¹ ðŸ˜‚",peaceful:"í‰í™” ðŸŒ¿",dramatic:"ê·¹ì  ðŸŽ­",nostalgic:"í–¥ìˆ˜ ðŸŒ…"}[S.mood]||S.mood||"ì—†ìŒ"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"ì¡°ëª…"}),e.jsx("p",{className:"text-white",children:{natural:"ìžì—°ê´‘ â˜€ï¸",sunset:"ì„ì–‘ ðŸŒ…",night:"ì•¼ê°„ ðŸŒ™",indoor:"ì‹¤ë‚´ ðŸ’¡",dramatic:"ê·¹ì  ðŸŽ¬",soft:"ì†Œí”„íŠ¸ ðŸŒ¤ï¸",backlight:"ì—­ê´‘ âœ¨",neon:"ë„¤ì˜¨ ðŸŒˆ"}[S.lighting]||S.lighting})]}),S.dialogues.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-2",children:"ëŒ€ì‚¬"}),e.jsx("div",{className:"space-y-2",children:S.dialogues.map(a=>e.jsxs("div",{className:"bg-gray-700/50 rounded-lg p-2",children:[e.jsx("p",{className:"text-xs text-purple-400",children:a.characterName||"ë‚˜ë ˆì´ì…˜"}),e.jsx("p",{className:"text-white text-sm",children:a.text})]},a.id))})]})]}):e.jsx("p",{className:"text-gray-400 text-center",children:"íŒ¨ë„ì„ ì„ íƒí•˜ì„¸ìš”"})})]})]}),K&&e.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-50",children:e.jsxs(J.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 border border-gray-700",children:[e.jsx("h3",{className:"text-xl font-bold text-white mb-4",children:"ðŸ” ë¹ ì§„ íŒ¨ë„ ë°œê²¬"}),e.jsx("p",{className:"text-gray-400 mb-4",children:"ë‹¤ìŒ íŒ¨ë„ ë²ˆí˜¸ê°€ ë¹ ì ¸ìžˆìŠµë‹ˆë‹¤:"}),e.jsx("div",{className:"bg-gray-900 rounded-lg p-4 mb-4 max-h-48 overflow-y-auto",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:ee.map(a=>e.jsxs("span",{className:"px-3 py-1 bg-red-500/20 text-red-400 rounded-full text-sm font-medium",children:["#",a]},a))})}),e.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["ì´ ",ee.length,"ê°œì˜ íŒ¨ë„ì´ ë¹ ì ¸ìžˆìŠµë‹ˆë‹¤. AIê°€ ì•žë’¤ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•˜ì—¬ ë¹ ì§„ íŒ¨ë„ì„ ìƒì„±í•©ë‹ˆë‹¤."]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(E,{variant:"primary",className:"flex-1",onClick:()=>Ne(ee),disabled:D,loading:D,children:"ë¹ ì§„ íŒ¨ë„ ìƒì„±"}),e.jsx(E,{variant:"secondary",onClick:()=>b(!1),children:"ì·¨ì†Œ"})]})]})})]})};export{Ps as default};
