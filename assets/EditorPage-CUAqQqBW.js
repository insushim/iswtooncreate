import{j as e,m as T,A as Re}from"./ui-D_LkVF2r.js";import{r as M,e as Ke,u as Me}from"./vendor-Vqvh67Lm.js";import{B as w}from"./Button-C3O7gUUW.js";import{u as we,c as oe,L as Ne,d as Oe}from"./index-BpwwsN8i.js";import{D as je,p as We}from"./parseJsonResponse-BC4W7KvA.js";import{g as ke,C as le}from"./GeminiService-CuSaiY5Y.js";import"./storage-BBQgdv-R.js";import"./ai-BpRkNtKl.js";const Ce=({tabs:s,activeTab:d,onChange:t,variant:l="default",size:g="md",fullWidth:i=!1,className:h=""})=>{const m={sm:"px-3 py-1.5 text-sm gap-1.5",md:"px-4 py-2 text-base gap-2",lg:"px-5 py-2.5 text-lg gap-2.5"};return(()=>{switch(l){case"pills":return e.jsx("div",{className:`flex gap-2 ${i?"w-full":""} ${h}`,children:s.map(a=>e.jsxs("button",{onClick:()=>!a.disabled&&t(a.id),disabled:a.disabled,className:`
                  flex items-center ${m[g]} rounded-lg
                  font-medium transition-all duration-200
                  ${i?"flex-1 justify-center":""}
                  ${a.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer"}
                  ${d===a.id?"bg-purple-600 text-white":"bg-gray-700 text-gray-400 hover:text-white hover:bg-gray-600"}
                `,children:[a.icon,a.label]},a.id))});case"underline":return e.jsx("div",{className:`flex border-b border-gray-700 ${i?"w-full":""} ${h}`,children:s.map(a=>e.jsxs("button",{onClick:()=>!a.disabled&&t(a.id),disabled:a.disabled,className:`
                  relative flex items-center ${m[g]}
                  font-medium transition-colors duration-200
                  ${i?"flex-1 justify-center":""}
                  ${a.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer"}
                  ${d===a.id?"text-purple-400":"text-gray-400 hover:text-white"}
                `,children:[a.icon,a.label,d===a.id&&e.jsx(T.div,{layoutId:"underline",className:"absolute bottom-0 left-0 right-0 h-0.5 bg-purple-500"})]},a.id))});default:return e.jsx("div",{className:`
              flex bg-gray-800 rounded-lg p-1
              ${i?"w-full":"inline-flex"}
              ${h}
            `,children:s.map(a=>e.jsxs("button",{onClick:()=>!a.disabled&&t(a.id),disabled:a.disabled,className:`
                  relative flex items-center ${m[g]} rounded-md
                  font-medium transition-all duration-200
                  ${i?"flex-1 justify-center":""}
                  ${a.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer"}
                  ${d===a.id?"text-white":"text-gray-400 hover:text-white"}
                `,children:[d===a.id&&e.jsx(T.div,{layoutId:"activeTab",className:"absolute inset-0 bg-gray-700 rounded-md",transition:{type:"spring",stiffness:500,damping:30}}),e.jsxs("span",{className:"relative z-10 flex items-center gap-2",children:[a.icon,a.label]})]},a.id))})}})()};async function He(s,d){const{text:t,fontSize:l=26,fontFamily:g="'Noto Sans KR', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif",maxWidth:i=400,bubbleStyle:h="normal"}=d;return t.trim()?new Promise((m,u)=>{const a=new Image;a.crossOrigin="anonymous",a.onload=()=>{const y=document.createElement("canvas").getContext("2d");if(!y){u(new Error("Canvas context not available"));return}y.font=`bold ${l}px ${g}`;const O=Fe(y,t,i),E=l*1.5,W=O.length*E,D=20,N=W+D*2,o=document.createElement("canvas"),r=o.getContext("2d");if(!r){u(new Error("Canvas context not available"));return}o.width=a.width,o.height=a.height+N,r.fillStyle="#ffffff",r.fillRect(0,0,o.width,N),r.strokeStyle="#e0e0e0",r.lineWidth=1,r.beginPath(),r.moveTo(0,N),r.lineTo(o.width,N),r.stroke(),r.drawImage(a,0,N),r.font=`bold ${l}px ${g}`,r.textAlign="center",r.textBaseline="top",h==="shout"?r.fillStyle="#d32f2f":h==="thought"?r.fillStyle="#666666":r.fillStyle="#1a1a1a";const A=D;O.forEach((L,H)=>{r.fillText(L,o.width/2,A+H*E)}),m(o.toDataURL("image/png"))},a.onerror=()=>{u(new Error("Failed to load image"))},a.src=s}):s}function Fe(s,d,t){const l=[],g=d.split("");let i="";for(const h of g){const m=i+h;s.measureText(m).width>t&&i.length>0?(l.push(i),i=h):i=m}return i&&l.push(i),l}const Ge=[{value:"full",label:"ì „ì²´"},{value:"large",label:"ëŒ€í˜•"},{value:"medium",label:"ì¤‘í˜•"},{value:"small",label:"ì†Œí˜•"},{value:"wide",label:"ê°€ë¡œí˜•"},{value:"tall",label:"ì„¸ë¡œí˜•"}],Ye=[{value:"close-up",label:"í´ë¡œì¦ˆì—…"},{value:"medium-shot",label:"ë¯¸ë””ì—„ìƒ·"},{value:"wide-shot",label:"ì™€ì´ë“œìƒ·"},{value:"extreme-close-up",label:"ìµìŠ¤íŠ¸ë¦¼ í´ë¡œì¦ˆì—…"},{value:"bird-eye",label:"ë²„ë“œì•„ì´"},{value:"worm-eye",label:"ì›œì•„ì´"},{value:"dutch-angle",label:"ë”ì¹˜ì•µê¸€"},{value:"over-shoulder",label:"ì˜¤ë²„ìˆ„ë”"},{value:"pov",label:"POV"}],Je=({panel:s,episodeId:d,onUpdate:t})=>{var W,D,N,o;const[l,g]=M.useState(!1),[i,h]=M.useState(null),[m,u]=M.useState(""),{currentProject:a}=we(),{addToast:p}=oe(),y=async(r="preview")=>{var A,L,H,U,R,F,G,V,_,n,C,K,Y,Z,J,z;if(a){g(!0);try{const f=s.composition||((A=s.background)==null?void 0:A.description)||"",k=a.worldBuilding,v=(k==null?void 0:k.era)||"",j=(k==null?void 0:k.setting)||"";let P="",$="",I=!1;v.includes("ì² ê¸°")||v.includes("ê³ êµ¬ë ¤")||v.includes("ancient")||v.includes("ì‚¼êµ­")||j.includes("ì² ê¸°")||j.includes("ê³ êµ¬ë ¤")||j.includes("ì‚¼êµ­")?(P="STRICTLY ancient Korean Three Kingdoms period (37 BC - 668 AD), traditional hanok architecture, wooden structures, thatched or tiled roofs, oil lamps, torches, NO modern elements whatsoever, NO electricity, NO modern buildings",$="authentic ancient Korean hanbok from Three Kingdoms era, layered silk robes, traditional hair accessories, jade ornaments for nobility, NO modern clothing",I=!0):v.includes("ì¡°ì„ ")||j.includes("ì¡°ì„ ")?(P="STRICTLY Joseon Dynasty Korea (1392-1897), traditional hanok, paper windows, wooden furniture, NO modern elements",$="Joseon era hanbok, gat (traditional hat) for men, jokduri for women, NO modern clothing",I=!0):v.includes("ê³ ë ¤")||j.includes("ê³ ë ¤")?(P="STRICTLY Goryeo Dynasty Korea (918-1392), Buddhist temples, traditional architecture, NO modern elements",$="Goryeo era traditional clothing, NO modern clothing",I=!0):(v.includes("í˜„ëŒ€")||v.includes("modern")||j.includes("í˜„ëŒ€"))&&(P="modern contemporary Korean setting, current day",$="modern Korean fashion",I=!1),P||/modern|office|computer|contemporary|apartment|city|urban|smartphone|laptop|desk|cubicle/i.test(f)&&(P="modern contemporary Korean setting, current day",$="modern Korean fashion");const ae=I?`

CRITICAL ERA CONSISTENCY: This is a HISTORICAL setting. ABSOLUTELY NO modern elements allowed - no modern buildings, no electricity, no modern clothing, no glasses, no modern hairstyles. Everything must be period-accurate.`:"",ce=s.characters.map(b=>{var S,X,Q,ee,se,x,ge,he,xe,pe,ue;const c=a.characters.find(te=>te.name===b.characterName||te.koreanName===b.characterName);if(c){const te=c.gender==="female"?"beautiful young Korean woman":c.gender==="male"?"handsome young Korean man":"Korean person",Se=c.age||25,De=((S=c.appearance)==null?void 0:S.hairColor)||"black",Le=((X=c.appearance)==null?void 0:X.hairStyle)||"long",Pe=((Q=c.appearance)==null?void 0:Q.eyeColor)||"dark brown",Te=((ee=c.appearance)==null?void 0:ee.bodyType)||"slim",fe=((se=c.appearance)==null?void 0:se.height)||"",Ee=((x=c.appearance)==null?void 0:x.skinTone)||"fair",Ae=((ge=c.appearance)==null?void 0:ge.faceShape)||"oval",ze=((he=c.appearance)==null?void 0:he.eyeShape)||"almond",be=((pe=(xe=c.appearance)==null?void 0:xe.distinguishingFeatures)==null?void 0:pe.join(", "))||"",ye=((ue=c.appearance)==null?void 0:ue.defaultOutfit)||"",ie=ye||$||(I?"traditional Korean hanbok":"modern Korean clothing"),Be=c.role==="protagonist"?`elegant ${ie}, high quality fabric`:c.role==="antagonist"?`imposing ${ie}, dark tones`:ie;return`[CHARACTER: ${c.name}] ${te}, exactly ${Se} years old, MUST have ${De} ${Le} hair, ${Pe} ${ze} eyes, ${Ee} skin, ${Ae} face, ${Te} body${fe?`, ${fe}`:""}, wearing ${Be}${be?`. Distinctive features: ${be}`:""}. CRITICAL: Keep this character's face and appearance EXACTLY consistent with reference image provided.`}return I?"Korean person in traditional hanbok, period-accurate clothing":"Korean person in modern clothing"}).join(`
`),de=((H=(L=s.dialogues)==null?void 0:L[0])==null?void 0:H.text)||"",me=`Webtoon illustration, manhwa style, clean lineart, cel-shading.

${f}

${ce||""}
${P?`Setting: ${P}`:""}
${$?`Costume: ${$}`:""}
${ae}

Camera: ${s.cameraAngle||"medium shot"}.
${m?`Style note: ${m}`:""}`,B=[];for(const b of s.characters){const c=a.characters.find(S=>S.name===b.characterName||S.koreanName===b.characterName);if(c){const S=((U=c.referenceImages)==null?void 0:U.filter(x=>x.type==="anchor"))||[];for(const x of S.slice(0,2))B.push(x.imageData);const X=((R=c.expressions)==null?void 0:R.filter(x=>x.imageData))||[];for(const x of X.slice(0,1))x.imageData&&B.push(x.imageData);const Q=((F=c.poses)==null?void 0:F.filter(x=>x.imageData))||[];for(const x of Q.slice(0,1))x.imageData&&B.push(x.imageData);const ee=((G=c.outfits)==null?void 0:G.filter(x=>x.imageData))||[];for(const x of ee.slice(0,1))x.imageData&&B.push(x.imageData);const se=((V=c.referenceImages)==null?void 0:V.filter(x=>x.type!=="anchor"))||[];for(const x of se.slice(0,1))B.push(x.imageData)}}if((_=a.worldBuilding)!=null&&_.mainLocations){const b=((C=(n=s.background)==null?void 0:n.description)==null?void 0:C.toLowerCase())||"";for(const c of a.worldBuilding.mainLocations)if(b.includes(c.name.toLowerCase())){for(const S of c.variations||[])if(S.generatedImage){B.push(S.generatedImage);break}}}const ne=a.episodes.find(b=>b.panels.some(c=>c.id===s.id));if(ne){const b=ne.panels.findIndex(c=>c.id===s.id);if(b>0){const c=ne.panels[b-1];(K=c.generatedImage)!=null&&K.imageData&&B.push(c.generatedImage.imageData)}}const Ie=B.slice(0,14),q=await ke.generateImage(me,{resolution:r,styleAnchor:"",referenceImages:Ie,useCache:!1});let re=q.imageData;if(de)try{const b=(Z=(Y=s.dialogues)==null?void 0:Y[0])==null?void 0:Z.bubbleStyle,c=b==="thought"||b==="shout"?b:"normal";re=await He(q.imageData,{text:de,position:((z=(J=s.dialogues)==null?void 0:J[0])==null?void 0:z.position)||{x:50,y:15},fontSize:28,bubbleStyle:c})}catch(b){console.error("Speech bubble rendering failed:",b)}r==="preview"?h(re):(t({generatedImage:{id:Date.now().toString(),resolution:r,imageData:re,promptUsed:me,generatedAt:new Date,fromCache:q.fromCache,cost:q.cost},status:"approved"}),h(null)),p({message:r==="preview"?"í”„ë¦¬ë·°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤":"ê³ í•´ìƒë„ ì´ë¯¸ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤",type:"success"})}catch(f){console.error("Image generation failed:",f),p({message:"ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤",type:"error"})}finally{g(!1)}}},O=()=>{i&&(t({generatedImage:{id:Date.now().toString(),resolution:"preview",imageData:i,promptUsed:s.visualPrompt,generatedAt:new Date,fromCache:!1,cost:.001},status:"approved"}),h(null))},E=((D=(W=s.dialogues)==null?void 0:W[0])==null?void 0:D.text)||"";return e.jsxs("div",{className:"bg-gray-800/50 rounded-xl border border-gray-700 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xl font-bold text-purple-400",children:["#",s.panelNumber]}),((o=(N=s.characters)==null?void 0:N[0])==null?void 0:o.characterName)&&e.jsx("span",{className:"text-sm text-gray-300",children:s.characters[0].characterName})]}),e.jsx(je,{options:Ge,value:s.size,onChange:r=>t({size:r}),placeholder:"í¬ê¸°"})]}),e.jsxs("div",{className:"p-4",children:[E&&e.jsxs("div",{className:"mb-4 p-3 bg-white/10 rounded-lg border-l-4 border-purple-500",children:[e.jsx("p",{className:"text-sm text-gray-400 mb-1",children:"ğŸ’¬ ëŒ€ì‚¬"}),e.jsxs("p",{className:"text-white text-lg font-medium",children:['"',E,'"']})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"col-span-2",children:e.jsx("div",{className:"aspect-[4/3] bg-gray-900 rounded-lg overflow-hidden relative",children:e.jsx(Re,{mode:"wait",children:l?e.jsx(T.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ne,{size:"lg",className:"mx-auto mb-2"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"ì´ë¯¸ì§€ ìƒì„± ì¤‘..."})]})},"loading"):i?e.jsx(T.img,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},src:i,alt:"Preview",className:"w-full h-full object-contain bg-gray-950"},"preview"):s.generatedImage?e.jsx(T.img,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},src:s.generatedImage.imageData,alt:`Panel ${s.panelNumber}`,className:"w-full h-full object-contain bg-gray-950"},"generated"):e.jsx(T.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-5xl mb-3 block",children:"ğŸ¨"}),e.jsx("p",{className:"text-gray-400",children:"ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”"})]})},"empty")})})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(je,{label:"ì•µê¸€",options:Ye,value:s.cameraAngle,onChange:r=>t({cameraAngle:r})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"ì¥ë©´ ì„¤ëª…"}),e.jsx("textarea",{value:s.composition,onChange:r=>t({composition:r.target.value}),rows:3,className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm resize-none",placeholder:"ì¥ë©´ ì„¤ëª…..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"ëŒ€ì‚¬ ìˆ˜ì •"}),e.jsx("textarea",{value:E,onChange:r=>{var L;const A=(L=s.dialogues)!=null&&L.length?[{...s.dialogues[0],text:r.target.value}]:[{id:`dlg-${Date.now()}`,text:r.target.value,type:"speech",bubbleStyle:"normal",position:{x:50,y:20},size:{width:200,height:80},fontSize:"medium"}];t({dialogues:A})},rows:2,className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm resize-none",placeholder:"ìºë¦­í„° ëŒ€ì‚¬..."})]})]})]}),e.jsxs("div",{className:"mt-4 p-3 bg-gray-700/50 rounded-lg",children:[e.jsx("label",{className:"block text-sm text-gray-300 mb-2",children:"âœï¸ ê·¸ë¦¼ ë³´ì™„ì  (ì¬ìƒì„± ì‹œ ë°˜ì˜)"}),e.jsx("textarea",{value:m,onChange:r=>u(r.target.value),rows:2,className:"w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm resize-none mb-3",placeholder:"ì˜ˆ: í‘œì •ì„ ë” ë°ê²Œ, ë°°ê²½ì„ ì–´ë‘¡ê²Œ, ì•µê¸€ì„ í´ë¡œì¦ˆì—…ìœ¼ë¡œ... (ëŒ€ì‚¬ëŠ” ìœ„ 'ëŒ€ì‚¬ ìˆ˜ì •'ì— ì…ë ¥)"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(w,{variant:"primary",onClick:()=>y("preview"),disabled:l,loading:l,children:s.generatedImage||i?"ğŸ”„ ì¬ìƒì„±":"ğŸ¨ ì´ë¯¸ì§€ ìƒì„±"}),i&&e.jsxs(e.Fragment,{children:[e.jsx(w,{variant:"primary",onClick:O,size:"sm",children:"âœ“ ìŠ¹ì¸"}),e.jsx(w,{variant:"secondary",onClick:()=>h(null),size:"sm",children:"ì·¨ì†Œ"})]})]})]})]})]})},Ue=({panels:s,selectedPanelId:d,onSelectPanel:t,onDeletePanel:l,onDeleteAllPanels:g})=>e.jsxs("div",{className:"bg-gray-800/50 rounded-xl border border-gray-700 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-white",children:"íƒ€ì„ë¼ì¸"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-sm text-gray-400",children:[s.length," íŒ¨ë„"]}),s.length>0&&g&&e.jsx("button",{onClick:()=>{confirm("ëª¨ë“  íŒ¨ë„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")&&g()},className:"text-xs text-red-400 hover:text-red-300 px-2 py-1 rounded bg-red-500/10 hover:bg-red-500/20",children:"ì „ì²´ ì‚­ì œ"})]})]}),e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-2",children:[s.map(i=>e.jsxs(T.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:()=>t(i.id),className:`
              group relative flex-shrink-0 w-20 h-28 rounded-lg overflow-hidden border-2 transition-all
              ${d===i.id?"border-purple-500 ring-2 ring-purple-500/30":"border-gray-700 hover:border-gray-600"}
            `,children:[i.generatedImage?e.jsx("img",{src:i.generatedImage.imageData,alt:`Panel ${i.panelNumber}`,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-gray-900 flex items-center justify-center",children:e.jsx("span",{className:"text-gray-600 text-2xl",children:"ğŸ¨"})}),e.jsx("div",{className:"absolute top-1 left-1 w-5 h-5 rounded bg-black/60 flex items-center justify-center",children:e.jsx("span",{className:"text-white text-xs font-bold",children:i.panelNumber})}),l&&e.jsx("div",{onClick:h=>{h.stopPropagation(),confirm(`íŒ¨ë„ ${i.panelNumber}ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)&&l(i.id)},className:"absolute top-1 right-1 w-5 h-5 rounded bg-red-500/80 hover:bg-red-500 flex items-center justify-center cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("span",{className:"text-white text-xs",children:"âœ•"})}),e.jsx("div",{className:`absolute bottom-1 right-1 w-2 h-2 rounded-full ${i.status==="approved"?"bg-green-500":i.status==="preview"?"bg-yellow-500":"bg-gray-500"}`}),d===i.id&&e.jsx(T.div,{layoutId:"selectedPanel",className:"absolute inset-0 border-2 border-purple-500 rounded-lg"})]},i.id)),e.jsx("button",{className:"flex-shrink-0 w-20 h-28 rounded-lg border-2 border-dashed border-gray-700 hover:border-gray-600 flex items-center justify-center transition-colors",children:e.jsx("svg",{className:"w-6 h-6 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]})]}),Ve=({projectTitle:s,episodeTitle:d,onSave:t,onPreview:l,onExport:g})=>{const{viewMode:i,setViewMode:h,zoom:m,setZoom:u}=oe(),a=[{id:"edit",label:"í¸ì§‘"},{id:"preview",label:"ë¯¸ë¦¬ë³´ê¸°"},{id:"split",label:"ë¶„í• "}];return e.jsx("div",{className:"bg-gray-800/80 backdrop-blur-sm border-b border-gray-700 px-4 py-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-white font-bold",children:s}),e.jsx("span",{className:"text-gray-400",children:"/"}),e.jsx("span",{className:"text-gray-300",children:d})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Ce,{tabs:a,activeTab:i,onChange:p=>h(p),variant:"pills",size:"sm"}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-gray-700 rounded-lg",children:[e.jsx("button",{onClick:()=>u(m-10),className:"text-gray-400 hover:text-white transition-colors",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),e.jsxs("span",{className:"text-white text-sm w-12 text-center",children:[m,"%"]}),e.jsx("button",{onClick:()=>u(m+10),className:"text-gray-400 hover:text-white transition-colors",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(w,{variant:"ghost",size:"sm",onClick:t,children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"})}),"ì €ì¥"]}),e.jsxs(w,{variant:"ghost",size:"sm",onClick:l,children:[e.jsxs("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]}),"ë¯¸ë¦¬ë³´ê¸°"]}),e.jsxs(w,{variant:"primary",size:"sm",onClick:g,children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),"ë‚´ë³´ë‚´ê¸°"]})]})]})})};async function _e(s){const t=[...s].sort((a,p)=>a.panelNumber-p.panelNumber).filter(a=>{var p;return(p=a.generatedImage)==null?void 0:p.imageData});if(t.length===0)throw new Error("ë‚´ë³´ë‚¼ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");const l=await Promise.all(t.map(a=>Ze(a.generatedImage.imageData))),g=Math.max(...l.map(a=>a.width)),i=l.reduce((a,p)=>a+p.height,0),h=document.createElement("canvas"),m=h.getContext("2d");if(!m)throw new Error("Canvas context not available");h.width=g,h.height=i,m.fillStyle="#ffffff",m.fillRect(0,0,h.width,h.height);let u=0;for(const a of l){const p=(g-a.width)/2;m.drawImage(a,p,u),u+=a.height}return h.toDataURL("image/png")}function Ze(s){return new Promise((d,t)=>{const l=new Image;l.crossOrigin="anonymous",l.onload=()=>d(l),l.onerror=()=>t(new Error("Failed to load image")),l.src=s})}function $e(s,d){const t=document.createElement("a");t.href=s,t.download=d,document.body.appendChild(t),t.click(),document.body.removeChild(t)}async function qe(s){const d=await _e(s.panels),t=`${s.episodeNumber}í™”_${s.title||"episode"}.png`;$e(d,t)}function Xe(s,d){var l;if(!((l=s.generatedImage)!=null&&l.imageData))throw new Error("ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");const t=`${d}í™”_íŒ¨ë„${s.panelNumber}.png`;$e(s.generatedImage.imageData,t)}async function ve(s){const t=[...s.panels].sort((l,g)=>l.panelNumber-g.panelNumber).filter(l=>{var g;return(g=l.generatedImage)==null?void 0:g.imageData});for(const l of t)Xe(l,s.episodeNumber),await new Promise(g=>setTimeout(g,300))}async function Qe(s,d){const{format:t}=d;switch(t){case"long-image":await qe(s);break;case"individual":await ve(s);break;case"zip":await ve(s);break;default:throw new Error("ì§€ì›í•˜ì§€ ì•ŠëŠ” ë‚´ë³´ë‚´ê¸° í˜•ì‹ì…ë‹ˆë‹¤.")}}const os=()=>{const{projectId:s}=Ke(),d=Me(),{currentProject:t,setCurrentProject:l,updatePanel:g,addPanel:i,deletePanel:h}=we(),{selectedEpisodeId:m,setSelectedEpisode:u,selectedPanelId:a,setSelectedPanel:p,addToast:y}=oe(),{user:O}=Oe(),[E,W]=M.useState(!0),[D,N]=M.useState(!1);M.useEffect(()=>{(async()=>{s&&(await l(s),W(!1))})()},[s,l]),M.useEffect(()=>{t!=null&&t.episodes.length&&!m&&u(t.episodes[0].id)},[t,m,u]);const o=t==null?void 0:t.episodes.find(n=>n.id===m),r=o==null?void 0:o.panels.find(n=>n.id===a),A=async(n,C)=>{m&&(await g(m,n,C),y({message:"íŒ¨ë„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤",type:"success"}))},L=async()=>{if(!(!o||!t)){N(!0),y({message:"íŒ¨ë„ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...",type:"info"});try{const n=t.worldBuilding,C=(n==null?void 0:n.era)||"ê³ ëŒ€ í•œêµ­",K=(n==null?void 0:n.setting)||"ì—­ì‚¬ë¬¼",Y=70,Z=`ì›¹íˆ° ${o.episodeNumber}í™” ì½˜í‹°. JSONìœ¼ë¡œ íŒ¨ë„ ${Y}ê°œ ìƒì„±.

ì¤„ê±°ë¦¬: ${o.summary}
ì„¸ê³„ê´€: ${C}, ${K}

ì¶œë ¥í˜•ì‹:
{"panels":[
{"n":1,"img":"ì˜ì–´ë¡œ ê·¸ë¦¼ì„¤ëª…","dialog":"í•œêµ­ì–´ ëŒ€ì‚¬"},
{"n":2,"img":"ì˜ì–´ë¡œ ê·¸ë¦¼ì„¤ëª…","dialog":""}
]}

ê·œì¹™:
1. ë°˜ë“œì‹œ ${Y}ê°œ íŒ¨ë„ ìƒì„± (ì›¹íˆ° 1í™” ë¶„ëŸ‰)
2. img = ì˜ì–´ë¡œë§Œ! ê·¸ë¦¼ ì„¤ëª… (êµ¬ë„, í‘œì •, ë°°ê²½ ìƒì„¸íˆ)
3. dialog = í•œêµ­ì–´ ëŒ€ì‚¬ë§Œ. ìºë¦­í„°ê°€ ì‹¤ì œë¡œ ë§í•˜ëŠ” ê²ƒ!
4. dialogì— ì¥ë©´ì„¤ëª… ì ˆëŒ€ ë„£ì§€ë§ˆ
5. ëŒ€ì‚¬ ì—†ëŠ” ì¥ë©´ì€ dialogë¥¼ ë¹ˆì¹¸ ""ìœ¼ë¡œ
6. í™˜ìƒ/ë¹™ì˜ ìŠ¤í† ë¦¬ë©´ ì²˜ìŒì€ í˜„ëŒ€, ì¤‘ê°„ì— ê³ ëŒ€ë¡œ ì „í™˜
7. ë‹¤ì–‘í•œ ì•µê¸€ ì‚¬ìš©: í´ë¡œì¦ˆì—…, ë¯¸ë””ì—„ìƒ·, ì™€ì´ë“œìƒ·, ë²„ë“œì•„ì´ ë“±
8. ê°ì • í‘œí˜„ ì¥ë©´ì€ í´ë¡œì¦ˆì—…ìœ¼ë¡œ
9. ì•¡ì…˜/ë°°ê²½ ì„¤ëª…ì€ ì™€ì´ë“œìƒ·ìœ¼ë¡œ
10. ëŒ€í™” ì¥ë©´ì€ ë¯¸ë””ì—„ìƒ·ìœ¼ë¡œ
11. 1~${Y}ë²ˆê¹Œì§€ ìˆœì„œëŒ€ë¡œ ìƒì„±`,J=await ke.generateText(Z,{temperature:.8,maxTokens:32e3,useCache:!1});console.log("[AI Response Raw]:",J);const z=We(J);if(console.log("[Parsed Result]:",JSON.stringify(z,null,2)),!z.panels||z.panels.length===0)throw new Error("íŒ¨ë„ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");for(const f of z.panels){console.log("[Panel Data]:",JSON.stringify(f,null,2));const k=f.n||f.panelNumber||1,v=f.img||f.sceneDescription||"";let j=f.dialog??f.dialogue??f.talk??f.speech??f.text??"";console.log(`[Panel ${k}] Dialog field:`,f.dialog,"| Dialogue field:",f.dialogue,"| Final:",j);const $=!/[ê°€-í£]/.test(j)&&/^[a-zA-Z\s,.\-'":;!?]+$/.test(j);j&&$&&(console.log(`[Panel ${k}] Filtered out English description:`,j),j="");const I=f.who||f.character||"",ae={episodeId:o.id,panelNumber:k,size:"medium",cameraAngle:"medium-shot",composition:v,characters:I?[{characterId:"",characterName:I,position:{x:50,y:50},scale:1,expression:"neutral",pose:"standing",action:"",facing:"front",layer:1}]:[],background:{locationName:"",description:v,timeOfDay:"afternoon",weather:"",mood:"",focusPoint:"",depth:"medium"},dialogues:j?[{id:`dlg-${Date.now()}-${k}`,text:j,type:"speech",bubbleStyle:"normal",position:{x:50,y:20},size:{width:200,height:80},fontSize:"medium"}]:[],sfx:[],mood:"",lighting:"natural",visualPrompt:v,status:"pending"};await i(o.id,ae)}await l(s),y({message:`${z.panels.length}ê°œ íŒ¨ë„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`,type:"success"})}catch(n){console.error("Panel generation failed:",n),y({message:"íŒ¨ë„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",type:"error"})}finally{N(!1)}}},H=async n=>{m&&(await h(m,n),p(null),y({message:"íŒ¨ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤",type:"success"}))},U=async()=>{if(o){for(const n of o.panels)await h(o.id,n.id);p(null),y({message:"ëª¨ë“  íŒ¨ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤",type:"success"})}};if(E)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsx(Ne,{size:"lg"})});if(!t)return e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs(le,{className:"text-center p-8",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4",children:"í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"}),e.jsx(w,{variant:"primary",onClick:()=>d("/dashboard"),children:"ëŒ€ì‹œë³´ë“œë¡œ ì´ë™"})]})});const R=(t==null?void 0:t.episodes.findIndex(n=>n.id===m))??-1,F=R>0,G=R<((t==null?void 0:t.episodes.length)??0)-1,V=()=>{if(F&&t){const n=t.episodes[R-1];u(n.id),n.panels.length>0?p(n.panels[0].id):p(null)}},_=()=>{if(G&&t){const n=t.episodes[R+1];u(n.id),n.panels.length>0?p(n.panels[0].id):p(null)}};return e.jsxs("div",{className:"min-h-screen bg-gray-900 flex flex-col",children:[e.jsxs("div",{className:"bg-gray-800 border-b border-gray-700 px-4 py-2 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(w,{variant:"ghost",size:"sm",onClick:()=>d(`/create/${s}`),className:"text-gray-400 hover:text-white",children:[e.jsx("svg",{className:"w-5 h-5 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})}),"í”„ë¡œì íŠ¸ ì„¤ì •"]}),e.jsx("div",{className:"text-gray-400",children:"|"}),e.jsx("h1",{className:"text-white font-bold",children:t.title})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{variant:"ghost",size:"sm",onClick:V,disabled:!F,className:F?"":"opacity-50 cursor-not-allowed",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsxs("div",{className:"bg-gray-700 rounded-lg px-4 py-2 min-w-[200px] text-center",children:[e.jsx("span",{className:"text-purple-400 font-bold",children:o?`${o.episodeNumber}í™”`:"ì—í”¼ì†Œë“œ ì„ íƒ"}),o&&e.jsxs("span",{className:"text-gray-400 ml-2 text-sm",children:["/ ",t.episodes.length,"í™”"]})]}),e.jsx(w,{variant:"ghost",size:"sm",onClick:_,disabled:!G,className:G?"":"opacity-50 cursor-not-allowed",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]}),e.jsx("div",{className:"flex items-center gap-2",children:O?e.jsxs("div",{className:"flex items-center gap-2 text-green-400 text-sm",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"})}),e.jsx("span",{children:"ìë™ ë™ê¸°í™” ì¤‘"})]}):e.jsxs("button",{onClick:()=>d("/settings"),className:"flex items-center gap-2 text-gray-400 hover:text-white text-sm transition-colors",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"})}),e.jsx("span",{children:"ë¡œê·¸ì¸í•˜ì—¬ ë™ê¸°í™”"})]})})]}),e.jsx(Ve,{projectTitle:t.title,episodeTitle:(o==null?void 0:o.title)||"ì—í”¼ì†Œë“œ ì„ íƒ",onSave:()=>y({message:"ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ (ìë™ ì €ì¥ë¨)",type:"success"}),onPreview:()=>d(`/preview/${s}`),onExport:async()=>{if(!o){y({message:"ì—í”¼ì†Œë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”",type:"error"});return}if(o.panels.filter(C=>{var K;return(K=C.generatedImage)==null?void 0:K.imageData}).length===0){y({message:"ë‚´ë³´ë‚¼ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤",type:"error"});return}try{y({message:"ì´ë¯¸ì§€ë¥¼ ë³‘í•©í•˜ê³  ìˆìŠµë‹ˆë‹¤...",type:"info"}),await Qe(o,{format:"long-image"}),y({message:"ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!",type:"success"})}catch(C){console.error("Export failed:",C),y({message:"ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤",type:"error"})}}}),e.jsxs("div",{className:"flex-1 flex",children:[e.jsxs("div",{className:"w-64 bg-gray-800/50 border-r border-gray-700 p-4 overflow-y-auto",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"ì—í”¼ì†Œë“œ"}),e.jsx("div",{className:"space-y-2",children:t.episodes.length>0?t.episodes.map(n=>e.jsxs(T.button,{whileHover:{x:4},onClick:()=>{u(n.id),n.panels.length>0&&p(n.panels[0].id)},className:`w-full text-left p-3 rounded-lg transition-colors ${m===n.id?"bg-purple-600/30 border border-purple-500":"bg-gray-700/50 hover:bg-gray-700"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-white font-medium",children:[n.episodeNumber,"í™”"]}),e.jsxs("span",{className:"text-gray-400 text-sm",children:[n.panels.length," íŒ¨ë„"]})]}),e.jsx("p",{className:"text-gray-400 text-sm truncate mt-1",children:n.title})]},n.id)):e.jsxs("div",{className:"text-center text-gray-400 py-8",children:[e.jsx("p",{children:"ì—í”¼ì†Œë“œê°€ ì—†ìŠµë‹ˆë‹¤"}),e.jsx(w,{variant:"ghost",size:"sm",className:"mt-2",onClick:()=>{},children:"ì—í”¼ì†Œë“œ ì¶”ê°€"})]})}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"ìºë¦­í„°"}),e.jsx("div",{className:"space-y-2",children:t.characters.map(n=>e.jsxs("div",{className:"flex items-center gap-3 p-2 rounded-lg bg-gray-700/30",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-sm",children:n.gender==="female"?"ğŸ‘©":"ğŸ‘¨"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white text-sm font-medium",children:n.name}),e.jsx("p",{className:"text-gray-400 text-xs",children:n.role})]})]},n.id))})]})]}),e.jsx("div",{className:"flex-1 flex flex-col p-4 overflow-hidden",children:o?e.jsxs(e.Fragment,{children:[e.jsx(Ue,{panels:o.panels,selectedPanelId:a,onSelectPanel:p,onDeletePanel:H,onDeleteAllPanels:U}),e.jsx("div",{className:"flex-1 mt-4 overflow-y-auto",children:r?e.jsx(Je,{panel:r,episodeId:o.id,onUpdate:n=>A(r.id,n)}):e.jsx(le,{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-4xl mb-4 block",children:"ğŸ¬"}),e.jsx("p",{className:"text-gray-400 mb-2",children:o.panels.length===0?"ì´ ì—í”¼ì†Œë“œì— íŒ¨ë„ì´ ì—†ìŠµë‹ˆë‹¤":"íŒ¨ë„ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ì¶”ê°€í•˜ì„¸ìš”"}),o.panels.length===0&&e.jsx("p",{className:"text-gray-500 text-sm mb-4",children:"AIê°€ ì—í”¼ì†Œë“œ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ íŒ¨ë„ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤"}),e.jsx(w,{variant:"primary",className:"mt-4",onClick:L,disabled:D,loading:D,children:D?"AI íŒ¨ë„ ìƒì„± ì¤‘...":"AI íŒ¨ë„ ìë™ ìƒì„±"})]})})})]}):e.jsx(le,{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-4xl mb-4 block",children:"ğŸ“š"}),e.jsx("p",{className:"text-gray-400",children:"ì—í”¼ì†Œë“œë¥¼ ì„ íƒí•˜ì„¸ìš”"})]})})}),e.jsxs("div",{className:"w-72 bg-gray-800/50 border-l border-gray-700 p-4 overflow-y-auto",children:[e.jsx(Ce,{tabs:[{id:"properties",label:"ì†ì„±"},{id:"dialogue",label:"ëŒ€ì‚¬"}],activeTab:"properties",onChange:()=>{},variant:"underline",fullWidth:!0}),e.jsx("div",{className:"mt-4",children:r?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"íŒ¨ë„ í¬ê¸°"}),e.jsx("p",{className:"text-white",children:r.size})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"ì¹´ë©”ë¼ ì•µê¸€"}),e.jsx("p",{className:"text-white",children:r.cameraAngle})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"ë¶„ìœ„ê¸°"}),e.jsx("p",{className:"text-white",children:r.mood})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"ì¡°ëª…"}),e.jsx("p",{className:"text-white",children:r.lighting})]}),r.dialogues.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-2",children:"ëŒ€ì‚¬"}),e.jsx("div",{className:"space-y-2",children:r.dialogues.map(n=>e.jsxs("div",{className:"bg-gray-700/50 rounded-lg p-2",children:[e.jsx("p",{className:"text-xs text-purple-400",children:n.characterName||"ë‚˜ë ˆì´ì…˜"}),e.jsx("p",{className:"text-white text-sm",children:n.text})]},n.id))})]})]}):e.jsx("p",{className:"text-gray-400 text-center",children:"íŒ¨ë„ì„ ì„ íƒí•˜ì„¸ìš”"})})]})]})]})};export{os as default};
