var S=Object.defineProperty;var I=(u,e,t)=>e in u?S(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var n=(u,e,t)=>I(u,typeof e!="symbol"?e+"":e,t);import{j as d,A as k,m as E}from"./ui-D_LkVF2r.js";import{r as x}from"./vendor-Vqvh67Lm.js";import{G as R}from"./ai-DlT_pbP0.js";import{l as q}from"./storage-286qJZbv.js";const N=({options:u,value:e,onChange:t,placeholder:s="선택하세요",label:i,disabled:a=!1,className:o=""})=>{const[r,c]=x.useState(!1),h=x.useRef(null),g=u.find(l=>l.value===e);x.useEffect(()=>{const l=w=>{h.current&&!h.current.contains(w.target)&&c(!1)};return document.addEventListener("mousedown",l),()=>document.removeEventListener("mousedown",l)},[]);const f=l=>{t(l),c(!1)};return d.jsxs("div",{className:`relative ${o}`,ref:h,children:[i&&d.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:i}),d.jsxs("button",{type:"button",onClick:()=>!a&&c(!r),disabled:a,className:`
          w-full flex items-center justify-between
          px-4 py-2.5 rounded-lg
          bg-gray-700 border border-gray-600
          text-left transition-all duration-200
          ${a?"opacity-50 cursor-not-allowed":"hover:border-purple-500 cursor-pointer"}
          ${r?"ring-2 ring-purple-500 border-purple-500":""}
        `,children:[d.jsx("span",{className:g?"text-white":"text-gray-400",children:g?d.jsxs("span",{className:"flex items-center gap-2",children:[g.icon,g.label]}):s}),d.jsx("svg",{className:`w-5 h-5 text-gray-400 transition-transform duration-200 ${r?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:d.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),d.jsx(k,{children:r&&d.jsx(E.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.15},className:"absolute z-50 w-full mt-2 py-1 bg-gray-800 border border-gray-700 rounded-lg shadow-xl max-h-60 overflow-auto",children:u.map(l=>d.jsxs("button",{onClick:()=>!l.disabled&&f(l.value),disabled:l.disabled,className:`
                  w-full px-4 py-2.5 text-left flex items-center gap-2
                  transition-colors duration-150
                  ${l.disabled?"opacity-50 cursor-not-allowed":"hover:bg-gray-700 cursor-pointer"}
                  ${l.value===e?"bg-purple-600/20 text-purple-400":"text-white"}
                `,children:[l.icon,l.label]},l.value))})})]})};class P{constructor(e){n(this,"tokens");n(this,"maxTokens");n(this,"refillRate");n(this,"lastRefill");n(this,"waitQueue",[]);n(this,"intervalId",null);this.maxTokens=e.maxRequests,this.tokens=this.maxTokens,this.refillRate=e.windowMs/e.maxRequests,this.lastRefill=Date.now(),this.intervalId=setInterval(()=>this.refill(),1e3)}async acquire(){if(this.refill(),this.tokens>=1){this.tokens--;return}return new Promise(e=>{this.waitQueue.push(e)})}refill(){const e=Date.now(),s=(e-this.lastRefill)/this.refillRate;if(s>=1)for(this.tokens=Math.min(this.maxTokens,this.tokens+Math.floor(s)),this.lastRefill=e;this.waitQueue.length>0&&this.tokens>=1;)this.tokens--,this.waitQueue.shift()()}getStatus(){return this.refill(),{availableTokens:Math.floor(this.tokens),maxTokens:this.maxTokens,queueLength:this.waitQueue.length,estimatedWait:this.waitQueue.length*this.refillRate}}reset(){this.tokens=this.maxTokens,this.lastRefill=Date.now(),this.waitQueue=[]}destroy(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.waitQueue=[]}}class M{constructor(){n(this,"store");n(this,"memoryCache");n(this,"maxMemoryEntries",100);n(this,"ttl");n(this,"hits",0);n(this,"misses",0);this.ttl=parseInt("3600000"),this.store=q.createInstance({name:"webtoon-forge-cache",storeName:"semantic_cache"}),this.memoryCache=new Map,this.loadFrequentEntries()}async get(e,t,s=.85){const i=this.normalizePrompt(e),a=this.generateKey(i,t),o=await this.getExact(a);if(o)return this.hits++,await this.updateAccessStats(a),o.value;const r=await this.findSimilar(i,t,s);return r?(this.hits++,await this.updateAccessStats(r.key),r.value):(this.misses++,null)}async set(e,t,s){const i=this.normalizePrompt(e),a=this.generateKey(i,s),o=this.extractKeywords(i),r={key:a,value:t,type:s,keywords:o,createdAt:Date.now(),accessCount:1,lastAccessed:Date.now()};this.memoryCache.set(a,r),await this.store.setItem(a,r),this.memoryCache.size>this.maxMemoryEntries&&this.evictLeastUsed()}async getExact(e){if(this.memoryCache.has(e)){const s=this.memoryCache.get(e);if(this.isValid(s))return s;this.memoryCache.delete(e)}const t=await this.store.getItem(e);return t&&this.isValid(t)?(this.memoryCache.set(e,t),t):null}async findSimilar(e,t,s){const i=this.extractKeywords(e);let a=null,o=s;for(const r of this.memoryCache.values()){if(r.type!==t||!this.isValid(r))continue;const c=this.calculateSimilarity(i,r.keywords);c>o&&(o=c,a=r)}if(!a||o<.95){const r=[];await this.store.iterate(c=>{c.type===t&&this.isValid(c)&&r.push(c)});for(const c of r){const h=this.calculateSimilarity(i,c.keywords);h>o&&(o=h,a=c)}}return a}normalizePrompt(e){return e.toLowerCase().replace(/\s+/g," ").replace(/[^\w\s가-힣]/g,"").trim()}generateKey(e,t){const s=this.hashString(e);return`${t}_${s}`}hashString(e){let t=0;for(let s=0;s<e.length;s++){const i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t}return Math.abs(t).toString(36)}extractKeywords(e){const t=new Set(["the","a","an","is","are","was","were","in","on","at","이","가","을","를","에","에서","의","와","과","는","은"]);return e.split(/\s+/).filter(s=>s.length>2&&!t.has(s)).slice(0,20)}calculateSimilarity(e,t){const s=new Set(e),i=new Set(t),a=new Set([...s].filter(r=>i.has(r))),o=new Set([...s,...i]);return o.size>0?a.size/o.size:0}isValid(e){return Date.now()-e.createdAt<this.ttl}async updateAccessStats(e){const t=this.memoryCache.get(e);t&&(t.accessCount++,t.lastAccessed=Date.now(),await this.store.setItem(e,t))}async loadFrequentEntries(){const e=[];await this.store.iterate(t=>{this.isValid(t)&&e.push(t)}),e.sort((t,s)=>s.accessCount-t.accessCount);for(const t of e.slice(0,this.maxMemoryEntries))this.memoryCache.set(t.key,t)}evictLeastUsed(){let e=null;for(const[t,s]of this.memoryCache.entries())(!e||s.lastAccessed<e.lastAccessed)&&(e={key:t,lastAccessed:s.lastAccessed});e&&this.memoryCache.delete(e.key)}async cleanup(){const e=[];await this.store.iterate((t,s)=>{this.isValid(t)||e.push(s)});for(const t of e)await this.store.removeItem(t),this.memoryCache.delete(t)}getHitRate(){const e=this.hits+this.misses;return e>0?this.hits/e*100:0}async getStats(){let e=0,t=0,s=0,i=0;return await this.store.iterate(a=>{e++,a.type==="text"&&t++,a.type==="image"&&s++,i+=a.value.length}),{totalEntries:e,textEntries:t,imageEntries:s,memoryEntries:this.memoryCache.size,estimatedSize:i,hitRate:this.getHitRate()}}}class A{constructor(e,t){n(this,"queue",[]);n(this,"processing",!1);n(this,"batchSize",5);n(this,"delayBetweenBatches",2e3);n(this,"processor");this.processor=e,t!=null&&t.batchSize&&(this.batchSize=t.batchSize),t!=null&&t.delay&&(this.delayBetweenBatches=t.delay)}add(e){return new Promise((t,s)=>{this.queue.push({item:e,resolve:t,reject:s,addedAt:Date.now()}),this.processQueue()})}async addBatch(e){const t=e.map(s=>this.add(s));return Promise.all(t)}async processQueue(){if(!(this.processing||this.queue.length===0)){for(this.processing=!0;this.queue.length>0;){const e=this.queue.splice(0,this.batchSize);(await Promise.allSettled(e.map(s=>this.processor(s.item)))).forEach((s,i)=>{s.status==="fulfilled"?e[i].resolve(s.value):e[i].reject(s.reason)}),this.queue.length>0&&await this.delay(this.delayBetweenBatches)}this.processing=!1}}delay(e){return new Promise(t=>setTimeout(t,e))}getStatus(){return{pending:this.queue.length,processing:this.processing,oldestItem:this.queue.length>0?Date.now()-this.queue[0].addedAt:0}}clear(){this.queue.forEach(e=>{e.reject(new Error("Queue cleared"))}),this.queue=[]}get length(){return this.queue.length}get isProcessing(){return this.processing}}class z{constructor(){n(this,"client",null);n(this,"textModel",null);n(this,"imageModel",null);n(this,"rateLimiter");n(this,"semanticCache");n(this,"batchQueue");n(this,"onCostRecord",null);n(this,"onCacheHit",null);this.rateLimiter=new P({maxRequests:parseInt("15"),windowMs:6e4}),this.semanticCache=new M,this.batchQueue=new A(e=>this.processImageRequest(e),{batchSize:5,delay:2e3})}initialize(e){if(!e)throw new Error("Gemini API key not provided");this.client=new R(e),this.textModel=this.client.getGenerativeModel({model:"gemini-2.0-flash-exp"}),this.imageModel=this.client.getGenerativeModel({model:"gemini-2.0-flash-exp",generationConfig:{responseModalities:["image","text"]}})}setCallbacks(e,t){this.onCostRecord=e,this.onCacheHit=t}ensureInitialized(){if(!this.client||!this.textModel||!this.imageModel)throw new Error("Gemini API key not configured. Please set VITE_GEMINI_API_KEY in .env file.")}async generateText(e,t={}){var r,c;this.ensureInitialized();const{systemPrompt:s=this.getDefaultSystemPrompt(),temperature:i=.8,maxTokens:a=4096,useCache:o=!0}=t;if(o){const h=await this.semanticCache.get(e,"text");if(h)return(r=this.onCacheHit)==null||r.call(this,"text"),h}await this.rateLimiter.acquire();try{const h=`${s}

${e}`,f=(await this.textModel.generateContent({contents:[{role:"user",parts:[{text:h}]}],generationConfig:{temperature:i,maxOutputTokens:a}})).response.text();o&&await this.semanticCache.set(e,f,"text");const l=this.calculateTextCost(e.length+f.length);return(c=this.onCostRecord)==null||c.call(this,"text",l),f}catch(h){throw console.error("Text generation failed:",h),this.handleError(h)}}async generateImage(e,t={}){var h,g,f,l,w;this.ensureInitialized();const{resolution:s="preview",styleAnchor:i="",referenceImages:a=[],useCache:o=!0,forceRegenerate:r=!1}=t,c=this.buildImagePrompt(e,i,s);if(o&&!r){const m=await this.semanticCache.get(c,"image",.85);if(m)return(h=this.onCacheHit)==null||h.call(this,"image"),{imageData:m,fromCache:!0,resolution:s,cost:0}}await this.rateLimiter.acquire();try{const m=[{role:"user",parts:[]}];if(a.length>0){for(const p of a.slice(0,3))m[0].parts.push({inlineData:{mimeType:"image/png",data:p.replace(/^data:image\/\w+;base64,/,"")}});m[0].parts.push({text:`Reference the above character images for consistency.

${c}`})}else m[0].parts.push({text:c});const v=(await this.imageModel.generateContent({contents:m})).response;let y="";for(const p of((l=(f=(g=v.candidates)==null?void 0:g[0])==null?void 0:f.content)==null?void 0:l.parts)||[])if(p.inlineData){const b=p.inlineData;y=`data:${b.mimeType};base64,${b.data}`;break}if(!y)throw new Error("No image generated");o&&await this.semanticCache.set(c,y,"image");const C=this.calculateImageCost(s);return(w=this.onCostRecord)==null||w.call(this,"image",C),{imageData:y,fromCache:!1,resolution:s,cost:C}}catch(m){throw console.error("Image generation failed:",m),this.handleError(m)}}async generateProgressiveImage(e,t={}){const s=await this.generateImage(e,{...t,resolution:"preview"});return{preview:s.imageData,previewCost:s.cost,generateHighRes:async()=>await this.generateImage(e,{...t,resolution:"high",useCache:!1})}}async batchGenerateImages(e){return this.batchQueue.addBatch(e)}async processImageRequest(e){return this.generateImage(e.prompt,e.options)}buildImagePrompt(e,t,s){const i={preview:"sketch quality, rough draft",standard:"clean linework, professional quality",high:"highly detailed, masterpiece quality, 4K resolution"}[s];return`
      ${t}

      ${i}

      Scene:
      ${e}

      Style requirements:
      - Webtoon/manhwa art style
      - Vertical scroll optimized
      - No text or speech bubbles in image
      - Consistent character proportions
      - Clean, professional finish
    `.trim()}getDefaultSystemPrompt(){return`당신은 전문 웹툰 작가이자 스토리보드 아티스트입니다.
항상 한국어로 응답하세요 (이미지 프롬프트 제외).
제공된 캐릭터와 스토리 컨텍스트와 일관성을 유지하세요.
JSON 형식으로 응답이 요청되면 유효한 JSON만 출력하세요.`}calculateTextCost(e){return e/4/1e3*1e-4}calculateImageCost(e){return{preview:.001,standard:.003,high:.005}[e]||.003}handleError(e){const t=(e==null?void 0:e.message)||String(e);return t.includes("quota")?new Error("API 할당량을 초과했습니다. 잠시 후 다시 시도해주세요."):t.includes("rate")?new Error("요청이 너무 빈번합니다. 잠시 후 다시 시도해주세요."):t.includes("safety")?new Error("안전 필터에 의해 차단되었습니다. 프롬프트를 수정해주세요."):t.includes("API key")?new Error("API 키가 올바르지 않습니다. 설정을 확인해주세요."):new Error(`생성 실패: ${t}`)}getRateLimiterStatus(){return this.rateLimiter.getStatus()}getBatchQueueStatus(){return this.batchQueue.getStatus()}async getCacheStats(){return this.semanticCache.getStats()}}const B=new z;export{N as D,B as g};
