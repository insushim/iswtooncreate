var v=Object.defineProperty;var I=(l,e,t)=>e in l?v(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var a=(l,e,t)=>I(l,typeof e!="symbol"?e+"":e,t);import{j as S,m as k}from"./ui-D_LkVF2r.js";import{G as b}from"./ai-DlT_pbP0.js";import{l as A}from"./storage-286qJZbv.js";const Q=({children:l,variant:e="default",padding:t="md",className:s="",onClick:i})=>{const r={none:"",sm:"p-3",md:"p-4",lg:"p-6"},o=`
    bg-gray-800/50 backdrop-blur-sm
    rounded-xl border border-gray-700
  `,n={default:"",hover:"transition-all duration-300 hover:border-purple-500/50 hover:shadow-lg hover:shadow-purple-500/10",interactive:"cursor-pointer transition-all duration-300 hover:border-purple-500/50 hover:shadow-lg hover:shadow-purple-500/10 hover:scale-[1.02]"};return e==="interactive"&&i?S.jsx(k.div,{whileHover:{scale:1.02},whileTap:{scale:.98},onClick:i,className:`${o} ${n[e]} ${r[t]} ${s}`,children:l}):S.jsx("div",{className:`${o} ${n[e]} ${r[t]} ${s}`,children:l})};class R{constructor(e){a(this,"tokens");a(this,"maxTokens");a(this,"refillRate");a(this,"lastRefill");a(this,"waitQueue",[]);a(this,"intervalId",null);this.maxTokens=e.maxRequests,this.tokens=this.maxTokens,this.refillRate=e.windowMs/e.maxRequests,this.lastRefill=Date.now(),this.intervalId=setInterval(()=>this.refill(),1e3)}async acquire(){if(this.refill(),this.tokens>=1){this.tokens--;return}return new Promise(e=>{this.waitQueue.push(e)})}refill(){const e=Date.now(),s=(e-this.lastRefill)/this.refillRate;if(s>=1)for(this.tokens=Math.min(this.maxTokens,this.tokens+Math.floor(s)),this.lastRefill=e;this.waitQueue.length>0&&this.tokens>=1;)this.tokens--,this.waitQueue.shift()()}getStatus(){return this.refill(),{availableTokens:Math.floor(this.tokens),maxTokens:this.maxTokens,queueLength:this.waitQueue.length,estimatedWait:this.waitQueue.length*this.refillRate}}reset(){this.tokens=this.maxTokens,this.lastRefill=Date.now(),this.waitQueue=[]}destroy(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.waitQueue=[]}}class q{constructor(){a(this,"store");a(this,"memoryCache");a(this,"maxMemoryEntries",100);a(this,"ttl");a(this,"hits",0);a(this,"misses",0);this.ttl=parseInt("3600000"),this.store=A.createInstance({name:"webtoon-forge-cache",storeName:"semantic_cache"}),this.memoryCache=new Map,this.loadFrequentEntries()}async get(e,t,s=.85){const i=this.normalizePrompt(e),r=this.generateKey(i,t),o=await this.getExact(r);if(o)return this.hits++,await this.updateAccessStats(r),o.value;const n=await this.findSimilar(i,t,s);return n?(this.hits++,await this.updateAccessStats(n.key),n.value):(this.misses++,null)}async set(e,t,s){const i=this.normalizePrompt(e),r=this.generateKey(i,s),o=this.extractKeywords(i),n={key:r,value:t,type:s,keywords:o,createdAt:Date.now(),accessCount:1,lastAccessed:Date.now()};this.memoryCache.set(r,n),await this.store.setItem(r,n),this.memoryCache.size>this.maxMemoryEntries&&this.evictLeastUsed()}async getExact(e){if(this.memoryCache.has(e)){const s=this.memoryCache.get(e);if(this.isValid(s))return s;this.memoryCache.delete(e)}const t=await this.store.getItem(e);return t&&this.isValid(t)?(this.memoryCache.set(e,t),t):null}async findSimilar(e,t,s){const i=this.extractKeywords(e);let r=null,o=s;for(const n of this.memoryCache.values()){if(n.type!==t||!this.isValid(n))continue;const h=this.calculateSimilarity(i,n.keywords);h>o&&(o=h,r=n)}if(!r||o<.95){const n=[];await this.store.iterate(h=>{h.type===t&&this.isValid(h)&&n.push(h)});for(const h of n){const c=this.calculateSimilarity(i,h.keywords);c>o&&(o=c,r=h)}}return r}normalizePrompt(e){return e.toLowerCase().replace(/\s+/g," ").replace(/[^\w\s가-힣]/g,"").trim()}generateKey(e,t){const s=this.hashString(e);return`${t}_${s}`}hashString(e){let t=0;for(let s=0;s<e.length;s++){const i=e.charCodeAt(s);t=(t<<5)-t+i,t=t&t}return Math.abs(t).toString(36)}extractKeywords(e){const t=new Set(["the","a","an","is","are","was","were","in","on","at","이","가","을","를","에","에서","의","와","과","는","은"]);return e.split(/\s+/).filter(s=>s.length>2&&!t.has(s)).slice(0,20)}calculateSimilarity(e,t){const s=new Set(e),i=new Set(t),r=new Set([...s].filter(n=>i.has(n))),o=new Set([...s,...i]);return o.size>0?r.size/o.size:0}isValid(e){return Date.now()-e.createdAt<this.ttl}async updateAccessStats(e){const t=this.memoryCache.get(e);t&&(t.accessCount++,t.lastAccessed=Date.now(),await this.store.setItem(e,t))}async loadFrequentEntries(){const e=[];await this.store.iterate(t=>{this.isValid(t)&&e.push(t)}),e.sort((t,s)=>s.accessCount-t.accessCount);for(const t of e.slice(0,this.maxMemoryEntries))this.memoryCache.set(t.key,t)}evictLeastUsed(){let e=null;for(const[t,s]of this.memoryCache.entries())(!e||s.lastAccessed<e.lastAccessed)&&(e={key:t,lastAccessed:s.lastAccessed});e&&this.memoryCache.delete(e.key)}async cleanup(){const e=[];await this.store.iterate((t,s)=>{this.isValid(t)||e.push(s)});for(const t of e)await this.store.removeItem(t),this.memoryCache.delete(t)}getHitRate(){const e=this.hits+this.misses;return e>0?this.hits/e*100:0}async getStats(){let e=0,t=0,s=0,i=0;return await this.store.iterate(r=>{e++,r.type==="text"&&t++,r.type==="image"&&s++,i+=r.value.length}),{totalEntries:e,textEntries:t,imageEntries:s,memoryEntries:this.memoryCache.size,estimatedSize:i,hitRate:this.getHitRate()}}}class E{constructor(e,t){a(this,"queue",[]);a(this,"processing",!1);a(this,"batchSize",5);a(this,"delayBetweenBatches",2e3);a(this,"processor");this.processor=e,t!=null&&t.batchSize&&(this.batchSize=t.batchSize),t!=null&&t.delay&&(this.delayBetweenBatches=t.delay)}add(e){return new Promise((t,s)=>{this.queue.push({item:e,resolve:t,reject:s,addedAt:Date.now()}),this.processQueue()})}async addBatch(e){const t=e.map(s=>this.add(s));return Promise.all(t)}async processQueue(){if(!(this.processing||this.queue.length===0)){for(this.processing=!0;this.queue.length>0;){const e=this.queue.splice(0,this.batchSize);(await Promise.allSettled(e.map(s=>this.processor(s.item)))).forEach((s,i)=>{s.status==="fulfilled"?e[i].resolve(s.value):e[i].reject(s.reason)}),this.queue.length>0&&await this.delay(this.delayBetweenBatches)}this.processing=!1}}delay(e){return new Promise(t=>setTimeout(t,e))}getStatus(){return{pending:this.queue.length,processing:this.processing,oldestItem:this.queue.length>0?Date.now()-this.queue[0].addedAt:0}}clear(){this.queue.forEach(e=>{e.reject(new Error("Queue cleared"))}),this.queue=[]}get length(){return this.queue.length}get isProcessing(){return this.processing}}class z{constructor(){a(this,"client",null);a(this,"textModel",null);a(this,"imageModel",null);a(this,"rateLimiter");a(this,"semanticCache");a(this,"batchQueue");a(this,"onCostRecord",null);a(this,"onCacheHit",null);this.rateLimiter=new R({maxRequests:parseInt("15"),windowMs:6e4}),this.semanticCache=new q,this.batchQueue=new E(e=>this.processImageRequest(e),{batchSize:5,delay:2e3})}initialize(e){if(!e)throw new Error("Gemini API key not provided");this.client=new b(e),this.textModel=this.client.getGenerativeModel({model:"gemini-2.0-flash-exp"}),this.imageModel=this.client.getGenerativeModel({model:"gemini-2.0-flash-exp",generationConfig:{responseModalities:["image","text"]}})}setCallbacks(e,t){this.onCostRecord=e,this.onCacheHit=t}ensureInitialized(){if(!this.client||!this.textModel||!this.imageModel){const s=localStorage.getItem("gemini_api_key")||void 0;if(s&&s!=="your_gemini_api_key_here")this.initialize(s);else throw new Error("Gemini API 키가 설정되지 않았습니다. 설정 페이지에서 API 키를 입력해주세요.")}}isInitialized(){return!!(this.client&&this.textModel&&this.imageModel)}setApiKey(e){localStorage.setItem("gemini_api_key",e),this.initialize(e)}getApiKey(){return localStorage.getItem("gemini_api_key")}async generateText(e,t={}){var n,h;this.ensureInitialized();const{systemPrompt:s=this.getDefaultSystemPrompt(),temperature:i=.8,maxTokens:r=4096,useCache:o=!0}=t;if(o){const c=await this.semanticCache.get(e,"text");if(c)return(n=this.onCacheHit)==null||n.call(this,"text"),c}await this.rateLimiter.acquire();try{const c=`${s}

${e}`,m=(await this.textModel.generateContent({contents:[{role:"user",parts:[{text:c}]}],generationConfig:{temperature:i,maxOutputTokens:r}})).response.text();o&&await this.semanticCache.set(e,m,"text");const d=this.calculateTextCost(e.length+m.length);return(h=this.onCostRecord)==null||h.call(this,"text",d),m}catch(c){throw console.error("Text generation failed:",c),this.handleError(c)}}async generateImage(e,t={}){var c,w,m,d,y;this.ensureInitialized();const{resolution:s="preview",styleAnchor:i="",referenceImages:r=[],useCache:o=!0,forceRegenerate:n=!1}=t,h=this.buildImagePrompt(e,i,s);if(o&&!n){const u=await this.semanticCache.get(h,"image",.85);if(u)return(c=this.onCacheHit)==null||c.call(this,"image"),{imageData:u,fromCache:!0,resolution:s,cost:0}}await this.rateLimiter.acquire();try{const u=[{role:"user",parts:[]}];if(r.length>0){for(const f of r.slice(0,3))u[0].parts.push({inlineData:{mimeType:"image/png",data:f.replace(/^data:image\/\w+;base64,/,"")}});u[0].parts.push({text:`Reference the above character images for consistency.

${h}`})}else u[0].parts.push({text:h});const x=(await this.imageModel.generateContent({contents:u})).response;let g="";for(const f of((d=(m=(w=x.candidates)==null?void 0:w[0])==null?void 0:m.content)==null?void 0:d.parts)||[])if(f.inlineData){const C=f.inlineData;g=`data:${C.mimeType};base64,${C.data}`;break}if(!g)throw new Error("No image generated");o&&await this.semanticCache.set(h,g,"image");const p=this.calculateImageCost(s);return(y=this.onCostRecord)==null||y.call(this,"image",p),{imageData:g,fromCache:!1,resolution:s,cost:p}}catch(u){throw console.error("Image generation failed:",u),this.handleError(u)}}async generateProgressiveImage(e,t={}){const s=await this.generateImage(e,{...t,resolution:"preview"});return{preview:s.imageData,previewCost:s.cost,generateHighRes:async()=>await this.generateImage(e,{...t,resolution:"high",useCache:!1})}}async batchGenerateImages(e){return this.batchQueue.addBatch(e)}async processImageRequest(e){return this.generateImage(e.prompt,e.options)}buildImagePrompt(e,t,s){const i={preview:"sketch quality, rough draft",standard:"clean linework, professional quality",high:"highly detailed, masterpiece quality, 4K resolution"}[s];return`
      ${t}

      ${i}

      Scene:
      ${e}

      Style requirements:
      - Webtoon/manhwa art style
      - Vertical scroll optimized
      - No text or speech bubbles in image
      - Consistent character proportions
      - Clean, professional finish
    `.trim()}getDefaultSystemPrompt(){return`당신은 전문 웹툰 작가이자 스토리보드 아티스트입니다.
항상 한국어로 응답하세요 (이미지 프롬프트 제외).
제공된 캐릭터와 스토리 컨텍스트와 일관성을 유지하세요.
JSON 형식으로 응답이 요청되면 유효한 JSON만 출력하세요.`}calculateTextCost(e){return e/4/1e3*1e-4}calculateImageCost(e){return{preview:.001,standard:.003,high:.005}[e]||.003}handleError(e){const t=(e==null?void 0:e.message)||String(e);return t.includes("quota")?new Error("API 할당량을 초과했습니다. 잠시 후 다시 시도해주세요."):t.includes("rate")?new Error("요청이 너무 빈번합니다. 잠시 후 다시 시도해주세요."):t.includes("safety")?new Error("안전 필터에 의해 차단되었습니다. 프롬프트를 수정해주세요."):t.includes("API key")?new Error("API 키가 올바르지 않습니다. 설정을 확인해주세요."):new Error(`생성 실패: ${t}`)}getRateLimiterStatus(){return this.rateLimiter.getStatus()}getBatchQueueStatus(){return this.batchQueue.getStatus()}async getCacheStats(){return this.semanticCache.getStats()}}const K=new z;export{Q as C,K as g};
