import{j as e,m as P,A as Pe}from"./ui-D_LkVF2r.js";import{r as z,e as Ae,u as Ee}from"./vendor-Vqvh67Lm.js";import{B as A}from"./Button-C3O7gUUW.js";import{u as ue,c as V,L as pe}from"./index-B1teBZmw.js";import{D as ge,p as De}from"./parseJsonResponse-BC4W7KvA.js";import{g as xe,C as Z}from"./GeminiService-K05Xw73n.js";import"./storage-BBQgdv-R.js";import"./ai-BpRkNtKl.js";const fe=({tabs:s,activeTab:c,onChange:r,variant:h="default",size:g="md",fullWidth:t=!1,className:d=""})=>{const l={sm:"px-3 py-1.5 text-sm gap-1.5",md:"px-4 py-2 text-base gap-2",lg:"px-5 py-2.5 text-lg gap-2.5"};return(()=>{switch(h){case"pills":return e.jsx("div",{className:`flex gap-2 ${t?"w-full":""} ${d}`,children:s.map(a=>e.jsxs("button",{onClick:()=>!a.disabled&&r(a.id),disabled:a.disabled,className:`
                  flex items-center ${l[g]} rounded-lg
                  font-medium transition-all duration-200
                  ${t?"flex-1 justify-center":""}
                  ${a.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer"}
                  ${c===a.id?"bg-purple-600 text-white":"bg-gray-700 text-gray-400 hover:text-white hover:bg-gray-600"}
                `,children:[a.icon,a.label]},a.id))});case"underline":return e.jsx("div",{className:`flex border-b border-gray-700 ${t?"w-full":""} ${d}`,children:s.map(a=>e.jsxs("button",{onClick:()=>!a.disabled&&r(a.id),disabled:a.disabled,className:`
                  relative flex items-center ${l[g]}
                  font-medium transition-colors duration-200
                  ${t?"flex-1 justify-center":""}
                  ${a.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer"}
                  ${c===a.id?"text-purple-400":"text-gray-400 hover:text-white"}
                `,children:[a.icon,a.label,c===a.id&&e.jsx(P.div,{layoutId:"underline",className:"absolute bottom-0 left-0 right-0 h-0.5 bg-purple-500"})]},a.id))});default:return e.jsx("div",{className:`
              flex bg-gray-800 rounded-lg p-1
              ${t?"w-full":"inline-flex"}
              ${d}
            `,children:s.map(a=>e.jsxs("button",{onClick:()=>!a.disabled&&r(a.id),disabled:a.disabled,className:`
                  relative flex items-center ${l[g]} rounded-md
                  font-medium transition-all duration-200
                  ${t?"flex-1 justify-center":""}
                  ${a.disabled?"opacity-50 cursor-not-allowed":"cursor-pointer"}
                  ${c===a.id?"text-white":"text-gray-400 hover:text-white"}
                `,children:[c===a.id&&e.jsx(P.div,{layoutId:"activeTab",className:"absolute inset-0 bg-gray-700 rounded-md",transition:{type:"spring",stiffness:500,damping:30}}),e.jsxs("span",{className:"relative z-10 flex items-center gap-2",children:[a.icon,a.label]})]},a.id))})}})()};async function Oe(s,c){const{text:r,position:h={x:50,y:35},fontSize:g=26,fontFamily:t="'Noto Sans KR', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif",maxWidth:d=300,bubbleStyle:l="normal",tailDirection:p="down"}=c;return r.trim()?new Promise((a,i)=>{const x=new Image;x.crossOrigin="anonymous",x.onload=()=>{const k=document.createElement("canvas"),v=k.getContext("2d");if(!v){i(new Error("Canvas context not available"));return}k.width=x.width,k.height=x.height,v.drawImage(x,0,0),v.font=`bold ${g}px ${t}`,v.textAlign="center",v.textBaseline="top";const $=Re(v,r,d),E=g*1.4,m=$.length*E,b=h.x/100*k.width,u=h.y/100*k.height,C=28,S=Math.max(d+C*2,180),O=Math.max(m+C*2,70);Le(v,b,u,S,O,l,p),v.fillStyle=l==="shout"?"#cc0000":"#000000";const n=u-O/2+C;$.forEach((D,M)=>{v.fillText(D,b,n+M*E)}),a(k.toDataURL("image/png"))},x.onerror=()=>{i(new Error("Failed to load image"))},x.src=s}):s}function Le(s,c,r,h,g,t,d="down"){const l=h/2,p=g/2;if(s.save(),s.shadowColor="rgba(0, 0, 0, 0.15)",s.shadowBlur=6,s.shadowOffsetX=2,s.shadowOffsetY=2,t==="thought")s.fillStyle="rgba(255, 255, 255, 0.95)",s.strokeStyle="#888888",s.lineWidth=1.5,s.beginPath(),s.ellipse(c,r,l*.9,p*.85,0,0,Math.PI*2),s.fill(),s.shadowColor="transparent",s.stroke(),s.fillStyle="rgba(255, 255, 255, 0.95)",s.beginPath(),s.arc(c+10,r+p+6,5,0,Math.PI*2),s.fill(),s.stroke(),s.beginPath(),s.arc(c+18,r+p+14,3,0,Math.PI*2),s.fill(),s.stroke();else{if(s.fillStyle=t==="shout"?"#fffde7":"#ffffff",s.strokeStyle=t==="shout"?"#e53935":"#222222",s.lineWidth=t==="shout"?2.5:2,s.beginPath(),s.ellipse(c,r,l,p,0,0,Math.PI*2),s.fill(),s.shadowColor="transparent",s.stroke(),s.fillStyle=t==="shout"?"#fffde7":"#ffffff",s.beginPath(),d==="down"){const a=c+5,i=r+p-5;s.moveTo(a-12,i),s.quadraticCurveTo(a,i+20,a+5,i+18),s.quadraticCurveTo(a+5,i+5,a+12,i)}else if(d==="left"){const a=c-l+5,i=r+5;s.moveTo(a,i-10),s.quadraticCurveTo(a-18,i,a-16,i+5),s.quadraticCurveTo(a-5,i+5,a,i+10)}else if(d==="right"){const a=c+l-5,i=r+5;s.moveTo(a,i-10),s.quadraticCurveTo(a+18,i,a+16,i+5),s.quadraticCurveTo(a+5,i+5,a,i+10)}if(s.fill(),s.beginPath(),d==="down"){const a=c+5,i=r+p-5;s.moveTo(a-12,i),s.quadraticCurveTo(a,i+20,a+5,i+18),s.quadraticCurveTo(a+5,i+5,a+12,i)}s.strokeStyle=t==="shout"?"#e53935":"#222222",s.stroke()}s.restore()}function Re(s,c,r){const h=[],g=c.split("");let t="";for(const d of g){const l=t+d;s.measureText(l).width>r&&t.length>0?(h.push(t),t=d):t=l}return t&&h.push(t),h}const ze=[{value:"full",label:"ì „ì²´"},{value:"large",label:"ëŒ€í˜•"},{value:"medium",label:"ì¤‘í˜•"},{value:"small",label:"ì†Œí˜•"},{value:"wide",label:"ê°€ë¡œí˜•"},{value:"tall",label:"ì„¸ë¡œí˜•"}],Me=[{value:"close-up",label:"í´ë¡œì¦ˆì—…"},{value:"medium-shot",label:"ë¯¸ë””ì—„ìƒ·"},{value:"wide-shot",label:"ì™€ì´ë“œìƒ·"},{value:"extreme-close-up",label:"ìµìŠ¤íŠ¸ë¦¼ í´ë¡œì¦ˆì—…"},{value:"bird-eye",label:"ë²„ë“œì•„ì´"},{value:"worm-eye",label:"ì›œì•„ì´"},{value:"dutch-angle",label:"ë”ì¹˜ì•µê¸€"},{value:"over-shoulder",label:"ì˜¤ë²„ìˆ„ë”"},{value:"pov",label:"POV"}],Ke=({panel:s,episodeId:c,onUpdate:r})=>{var $,E,m,b;const[h,g]=z.useState(!1),[t,d]=z.useState(null),[l,p]=z.useState(""),{currentProject:a}=ue(),{addToast:i}=V(),x=async(u="preview")=>{var C,S,O,n,D,M,X,K;if(a){g(!0);try{const T=s.composition||((C=s.background)==null?void 0:C.description)||"",f=/modern|office|computer|contemporary|apartment|city|urban|smartphone|laptop|desk|cubicle/i.test(T),j=a.worldBuilding,I=(j==null?void 0:j.era)||"ancient",N=(j==null?void 0:j.setting)||"",G=((S=a.planning)==null?void 0:S.synopsis)||"",B=a.episodes.find(y=>y.panels.some(o=>o.id===s.id)),Y=(B==null?void 0:B.summary)||"";let L="",R="";f?(L="modern contemporary Korean setting, current day, 2024",R="modern Korean fashion, office wear or casual modern clothing"):I.includes("ì² ê¸°")||I.includes("ê³ êµ¬ë ¤")||I.includes("ancient")||I.includes("ì‚¼êµ­")?(L="ancient Korean Three Kingdoms period (37 BC - 668 AD), traditional hanok architecture, wooden structures, thatched or tiled roofs, oil lamps, no modern elements whatsoever",R="authentic ancient Korean hanbok from Three Kingdoms era, layered silk robes, traditional hair accessories, jade ornaments for nobility"):I.includes("ì¡°ì„ ")&&(L="Joseon Dynasty Korea (1392-1897), traditional hanok, paper windows, wooden furniture",R="Joseon era hanbok, gat (traditional hat) for men, jokduri for women");const be=N||G?`
STORY CONTEXT: ${N} ${G}`.substring(0,500):"",_=s.characters.map(y=>{var w,F,se,ae,te,re,ne,ie,le,oe,ce;const o=a.characters.find(q=>q.name===y.characterName||q.koreanName===y.characterName);if(o){const q=o.gender==="female"?"beautiful young Korean woman":o.gender==="male"?"handsome young Korean man":"Korean person",je=o.age||25,Ne=((w=o.appearance)==null?void 0:w.hairColor)||"black",we=((F=o.appearance)==null?void 0:F.hairStyle)||"long",ke=((se=o.appearance)==null?void 0:se.eyeColor)||"dark brown",Ce=((ae=o.appearance)==null?void 0:ae.bodyType)||"slim",de=((te=o.appearance)==null?void 0:te.height)||"",Te=((re=o.appearance)==null?void 0:re.skinTone)||"fair",$e=((ne=o.appearance)==null?void 0:ne.faceShape)||"oval",Se=((ie=o.appearance)==null?void 0:ie.eyeShape)||"almond",me=((oe=(le=o.appearance)==null?void 0:le.distinguishingFeatures)==null?void 0:oe.join(", "))||"",he=((ce=o.appearance)==null?void 0:ce.defaultOutfit)||"",U=he||R,Ie=o.role==="protagonist"?`elegant ${U}, high quality fabric`:o.role==="antagonist"?`imposing ${U}, dark tones`:U;return`[CHARACTER: ${o.name}] ${q}, exactly ${je} years old, MUST have ${Ne} ${we} hair, ${ke} ${Se} eyes, ${Te} skin, ${$e} face, ${Ce} body${de?`, ${de}`:""}, wearing ${Ie}${me?`. Distinctive features: ${me}`:""}. CRITICAL: Keep this character's face and appearance EXACTLY consistent with reference image provided.`}return f?"Korean person in modern clothing":"Korean person in traditional hanbok"}).join(`
`),ye=l?`

User feedback to apply: ${l}`:"",Q=((n=(O=s.dialogues)==null?void 0:O[0])==null?void 0:n.text)||"",ve=s.characters.some(y=>{const o=a.characters.find(w=>w.name===y.characterName||w.koreanName===y.characterName);return o&&o.referenceImages&&o.referenceImages.length>0}),ee=`[CRITICAL INSTRUCTION - READ FIRST]
DO NOT include any of the following in this image:
- NO speech bubbles
- NO text or letters
- NO white ovals
- NO dialogue boxes
- NO writing of any kind
- NO Korean, English, or any text
Generate ONLY a pure illustration without any text elements.

---

Create a Korean webtoon manhwa panel illustration.

SCENE: ${T}

${ve?`[CHARACTER CONSISTENCY - MANDATORY]
The reference image(s) provided show the exact appearance of the character(s).
You MUST replicate these features EXACTLY:
- EXACT same hair color (do not change)
- EXACT same hair style (do not change)
- EXACT same face shape
- EXACT same eye shape and color
- The character must look like the SAME PERSON in every panel
DO NOT deviate from the reference images.`:""}

${_?`CHARACTER DETAILS:
${_}`:""}

${L?`SETTING: ${L}`:""}
${R?`COSTUMES: ${R}`:""}
${be}
${Y?`STORY CONTEXT: ${Y.substring(0,200)}`:""}
${ye}

ART STYLE: Korean webtoon, clean lineart, soft cel-shading, ${s.cameraAngle||"medium shot"}, high quality.

FINAL REMINDER: This image must contain ZERO text, ZERO speech bubbles, ZERO letters. Only draw the scene.`,W=[];for(const y of s.characters){const o=a.characters.find(w=>w.name===y.characterName||w.koreanName===y.characterName);if(o&&o.referenceImages&&o.referenceImages.length>0){const w=o.referenceImages.find(F=>F.type==="anchor");w?W.push(w.imageData):W.push(o.referenceImages[0].imageData)}}const H=await xe.generateImage(ee,{resolution:u,styleAnchor:"",referenceImages:W,useCache:!1});let J=H.imageData;if(Q)try{i({message:"ëŒ€ì‚¬ë¥¼ í•©ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...",type:"info"});const y=(M=(D=s.dialogues)==null?void 0:D[0])==null?void 0:M.bubbleStyle,o=y==="thought"||y==="shout"?y:"normal";J=await Oe(H.imageData,{text:Q,position:((K=(X=s.dialogues)==null?void 0:X[0])==null?void 0:K.position)||{x:50,y:15},fontSize:28,bubbleStyle:o})}catch(y){console.error("Speech bubble rendering failed:",y)}u==="preview"?d(J):(r({generatedImage:{id:Date.now().toString(),resolution:u,imageData:J,promptUsed:ee,generatedAt:new Date,fromCache:H.fromCache,cost:H.cost},status:"approved"}),d(null)),i({message:u==="preview"?"í”„ë¦¬ë·°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤":"ê³ í•´ìƒë„ ì´ë¯¸ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤",type:"success"})}catch(T){console.error("Image generation failed:",T),i({message:"ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤",type:"error"})}finally{g(!1)}}},k=()=>{t&&(r({generatedImage:{id:Date.now().toString(),resolution:"preview",imageData:t,promptUsed:s.visualPrompt,generatedAt:new Date,fromCache:!1,cost:.001},status:"approved"}),d(null))},v=((E=($=s.dialogues)==null?void 0:$[0])==null?void 0:E.text)||"";return e.jsxs("div",{className:"bg-gray-800/50 rounded-xl border border-gray-700 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xl font-bold text-purple-400",children:["#",s.panelNumber]}),((b=(m=s.characters)==null?void 0:m[0])==null?void 0:b.characterName)&&e.jsx("span",{className:"text-sm text-gray-300",children:s.characters[0].characterName})]}),e.jsx(ge,{options:ze,value:s.size,onChange:u=>r({size:u}),placeholder:"í¬ê¸°"})]}),e.jsxs("div",{className:"p-4",children:[v&&e.jsxs("div",{className:"mb-4 p-3 bg-white/10 rounded-lg border-l-4 border-purple-500",children:[e.jsx("p",{className:"text-sm text-gray-400 mb-1",children:"ğŸ’¬ ëŒ€ì‚¬"}),e.jsxs("p",{className:"text-white text-lg font-medium",children:['"',v,'"']})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"col-span-2",children:e.jsx("div",{className:"aspect-[4/3] bg-gray-900 rounded-lg overflow-hidden relative",children:e.jsx(Pe,{mode:"wait",children:h?e.jsx(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(pe,{size:"lg",className:"mx-auto mb-2"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"ì´ë¯¸ì§€ ìƒì„± ì¤‘..."})]})},"loading"):t?e.jsx(P.img,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},src:t,alt:"Preview",className:"w-full h-full object-contain bg-gray-950"},"preview"):s.generatedImage?e.jsx(P.img,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},src:s.generatedImage.imageData,alt:`Panel ${s.panelNumber}`,className:"w-full h-full object-contain bg-gray-950"},"generated"):e.jsx(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-5xl mb-3 block",children:"ğŸ¨"}),e.jsx("p",{className:"text-gray-400",children:"ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”"})]})},"empty")})})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(ge,{label:"ì•µê¸€",options:Me,value:s.cameraAngle,onChange:u=>r({cameraAngle:u})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"ì¥ë©´ ì„¤ëª…"}),e.jsx("textarea",{value:s.composition,onChange:u=>r({composition:u.target.value}),rows:3,className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm resize-none",placeholder:"ì¥ë©´ ì„¤ëª…..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-400 mb-1",children:"ëŒ€ì‚¬ ìˆ˜ì •"}),e.jsx("textarea",{value:v,onChange:u=>{var S;const C=(S=s.dialogues)!=null&&S.length?[{...s.dialogues[0],text:u.target.value}]:[{id:`dlg-${Date.now()}`,text:u.target.value,type:"speech",bubbleStyle:"normal",position:{x:50,y:20},size:{width:200,height:80},fontSize:"medium"}];r({dialogues:C})},rows:2,className:"w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm resize-none",placeholder:"ìºë¦­í„° ëŒ€ì‚¬..."})]})]})]}),e.jsxs("div",{className:"mt-4 p-3 bg-gray-700/50 rounded-lg",children:[e.jsx("label",{className:"block text-sm text-gray-300 mb-2",children:"âœï¸ ê·¸ë¦¼ ë³´ì™„ì  (ì¬ìƒì„± ì‹œ ë°˜ì˜)"}),e.jsx("textarea",{value:l,onChange:u=>p(u.target.value),rows:2,className:"w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm resize-none mb-3",placeholder:"ì˜ˆ: í‘œì •ì„ ë” ë°ê²Œ, ë°°ê²½ì„ ì–´ë‘¡ê²Œ, ì•µê¸€ì„ í´ë¡œì¦ˆì—…ìœ¼ë¡œ... (ëŒ€ì‚¬ëŠ” ìœ„ 'ëŒ€ì‚¬ ìˆ˜ì •'ì— ì…ë ¥)"}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(A,{variant:"primary",onClick:()=>x("preview"),disabled:h,loading:h,children:s.generatedImage||t?"ğŸ”„ ì¬ìƒì„±":"ğŸ¨ ì´ë¯¸ì§€ ìƒì„±"}),t&&e.jsxs(e.Fragment,{children:[e.jsx(A,{variant:"primary",onClick:k,size:"sm",children:"âœ“ ìŠ¹ì¸"}),e.jsx(A,{variant:"secondary",onClick:()=>d(null),size:"sm",children:"ì·¨ì†Œ"})]})]})]})]})]})},Be=({panels:s,selectedPanelId:c,onSelectPanel:r,onDeletePanel:h,onDeleteAllPanels:g})=>e.jsxs("div",{className:"bg-gray-800/50 rounded-xl border border-gray-700 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-white",children:"íƒ€ì„ë¼ì¸"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-sm text-gray-400",children:[s.length," íŒ¨ë„"]}),s.length>0&&g&&e.jsx("button",{onClick:()=>{confirm("ëª¨ë“  íŒ¨ë„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")&&g()},className:"text-xs text-red-400 hover:text-red-300 px-2 py-1 rounded bg-red-500/10 hover:bg-red-500/20",children:"ì „ì²´ ì‚­ì œ"})]})]}),e.jsxs("div",{className:"flex gap-2 overflow-x-auto pb-2",children:[s.map(t=>e.jsxs(P.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:()=>r(t.id),className:`
              group relative flex-shrink-0 w-20 h-28 rounded-lg overflow-hidden border-2 transition-all
              ${c===t.id?"border-purple-500 ring-2 ring-purple-500/30":"border-gray-700 hover:border-gray-600"}
            `,children:[t.generatedImage?e.jsx("img",{src:t.generatedImage.imageData,alt:`Panel ${t.panelNumber}`,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-gray-900 flex items-center justify-center",children:e.jsx("span",{className:"text-gray-600 text-2xl",children:"ğŸ¨"})}),e.jsx("div",{className:"absolute top-1 left-1 w-5 h-5 rounded bg-black/60 flex items-center justify-center",children:e.jsx("span",{className:"text-white text-xs font-bold",children:t.panelNumber})}),h&&e.jsx("div",{onClick:d=>{d.stopPropagation(),confirm(`íŒ¨ë„ ${t.panelNumber}ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)&&h(t.id)},className:"absolute top-1 right-1 w-5 h-5 rounded bg-red-500/80 hover:bg-red-500 flex items-center justify-center cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx("span",{className:"text-white text-xs",children:"âœ•"})}),e.jsx("div",{className:`absolute bottom-1 right-1 w-2 h-2 rounded-full ${t.status==="approved"?"bg-green-500":t.status==="preview"?"bg-yellow-500":"bg-gray-500"}`}),c===t.id&&e.jsx(P.div,{layoutId:"selectedPanel",className:"absolute inset-0 border-2 border-purple-500 rounded-lg"})]},t.id)),e.jsx("button",{className:"flex-shrink-0 w-20 h-28 rounded-lg border-2 border-dashed border-gray-700 hover:border-gray-600 flex items-center justify-center transition-colors",children:e.jsx("svg",{className:"w-6 h-6 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]})]}),Ye=({projectTitle:s,episodeTitle:c,onSave:r,onPreview:h,onExport:g})=>{const{viewMode:t,setViewMode:d,zoom:l,setZoom:p}=V(),a=[{id:"edit",label:"í¸ì§‘"},{id:"preview",label:"ë¯¸ë¦¬ë³´ê¸°"},{id:"split",label:"ë¶„í• "}];return e.jsx("div",{className:"bg-gray-800/80 backdrop-blur-sm border-b border-gray-700 px-4 py-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-white font-bold",children:s}),e.jsx("span",{className:"text-gray-400",children:"/"}),e.jsx("span",{className:"text-gray-300",children:c})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(fe,{tabs:a,activeTab:t,onChange:i=>d(i),variant:"pills",size:"sm"}),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-gray-700 rounded-lg",children:[e.jsx("button",{onClick:()=>p(l-10),className:"text-gray-400 hover:text-white transition-colors",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M20 12H4"})})}),e.jsxs("span",{className:"text-white text-sm w-12 text-center",children:[l,"%"]}),e.jsx("button",{onClick:()=>p(l+10),className:"text-gray-400 hover:text-white transition-colors",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(A,{variant:"ghost",size:"sm",onClick:r,children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"})}),"ì €ì¥"]}),e.jsxs(A,{variant:"ghost",size:"sm",onClick:h,children:[e.jsxs("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"})]}),"ë¯¸ë¦¬ë³´ê¸°"]}),e.jsxs(A,{variant:"primary",size:"sm",onClick:g,children:[e.jsx("svg",{className:"w-4 h-4 mr-1",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"})}),"ë‚´ë³´ë‚´ê¸°"]})]})]})})},Ze=()=>{const{projectId:s}=Ae(),c=Ee(),{currentProject:r,setCurrentProject:h,updatePanel:g,addPanel:t,deletePanel:d}=ue(),{selectedEpisodeId:l,setSelectedEpisode:p,selectedPanelId:a,setSelectedPanel:i,addToast:x}=V(),[k,v]=z.useState(!0),[$,E]=z.useState(!1);z.useEffect(()=>{(async()=>{s&&(await h(s),v(!1))})()},[s,h]),z.useEffect(()=>{r!=null&&r.episodes.length&&!l&&p(r.episodes[0].id)},[r,l,p]);const m=r==null?void 0:r.episodes.find(n=>n.id===l),b=m==null?void 0:m.panels.find(n=>n.id===a),u=async(n,D)=>{l&&(await g(l,n,D),x({message:"íŒ¨ë„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤",type:"success"}))},C=async()=>{if(!(!m||!r)){E(!0),x({message:"íŒ¨ë„ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...",type:"info"});try{const n=r.worldBuilding,D=(n==null?void 0:n.era)||"ê³ ëŒ€ í•œêµ­",M=(n==null?void 0:n.setting)||"ì—­ì‚¬ë¬¼",X=`ì›¹íˆ° ${m.episodeNumber}í™” ì½˜í‹°. JSONìœ¼ë¡œ íŒ¨ë„ 10ê°œ.

ì¤„ê±°ë¦¬: ${m.summary}
ì„¸ê³„ê´€: ${D}, ${M}

ì¶œë ¥í˜•ì‹:
{"panels":[
{"n":1,"img":"ì˜ì–´ë¡œ ê·¸ë¦¼ì„¤ëª…","dialog":"í•œêµ­ì–´ ëŒ€ì‚¬"},
{"n":2,"img":"ì˜ì–´ë¡œ ê·¸ë¦¼ì„¤ëª…","dialog":""}
]}

ì˜ˆì‹œ (í™˜ìƒ/ë¹™ì˜ë¬¼ì˜ ê²½ìš°):
{"panels":[
{"n":1,"img":"modern Korean office, exhausted young woman at desk, late night, computer screen glowing, contemporary setting","dialog":"ì•„... í”¼ê³¤í•´. ë”ëŠ” ëª» ë²„í‹°ê² ì–´..."},
{"n":2,"img":"woman collapsing on desk, passing out, modern office background","dialog":""},
{"n":3,"img":"bright light, transition scene, swirling effect","dialog":""},
{"n":4,"img":"ancient Korean palace bedroom, woman waking up on wooden bed, confused expression, traditional hanbok, oil lamps, Goguryeo era","dialog":"...ì–´ë””ì•¼ ì—¬ê¸°?"},
{"n":5,"img":"close up of woman's face looking at her hands, shocked expression, ancient Korean room","dialog":"ì´ ì†ì€... ë‚´ ì†ì´ ì•„ë‹ˆì•¼!"}
]}

ê·œì¹™:
1. img = ì˜ì–´ë¡œë§Œ! ê·¸ë¦¼ ì„¤ëª…
2. dialog = í•œêµ­ì–´ ëŒ€ì‚¬. ìºë¦­í„°ê°€ ì‹¤ì œë¡œ ë§í•˜ëŠ” ê²ƒë§Œ!
3. dialogì— ì¥ë©´ì„¤ëª… ì ˆëŒ€ ë„£ì§€ë§ˆ
4. ëŒ€ì‚¬ ì—†ëŠ” ì¥ë©´ì€ dialogë¥¼ ë¹ˆì¹¸ ""ìœ¼ë¡œ
5. í™˜ìƒ/ë¹™ì˜ ìŠ¤í† ë¦¬ë©´ ì²˜ìŒì€ í˜„ëŒ€, ì¤‘ê°„ì— ê³ ëŒ€ë¡œ ì „í™˜`,K=await xe.generateText(X,{temperature:.8,maxTokens:8e3,useCache:!1});console.log("[AI Response Raw]:",K);const T=De(K);if(console.log("[Parsed Result]:",JSON.stringify(T,null,2)),!T.panels||T.panels.length===0)throw new Error("íŒ¨ë„ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");for(const f of T.panels){console.log("[Panel Data]:",JSON.stringify(f,null,2));const j=f.n||f.panelNumber||1,I=f.img||f.sceneDescription||"";let N=f.dialog??f.dialogue??f.talk??f.speech??f.text??"";console.log(`[Panel ${j}] Dialog field:`,f.dialog,"| Dialogue field:",f.dialogue,"| Final:",N);const B=!/[ê°€-í£]/.test(N)&&/^[a-zA-Z\s,.\-'":;!?]+$/.test(N);N&&B&&(console.log(`[Panel ${j}] Filtered out English description:`,N),N="");const Y=f.who||f.character||"",L={episodeId:m.id,panelNumber:j,size:"medium",cameraAngle:"medium-shot",composition:I,characters:Y?[{characterId:"",characterName:Y,position:{x:50,y:50},scale:1,expression:"neutral",pose:"standing",action:"",facing:"front",layer:1}]:[],background:{locationName:"",description:I,timeOfDay:"afternoon",weather:"",mood:"",focusPoint:"",depth:"medium"},dialogues:N?[{id:`dlg-${Date.now()}-${j}`,text:N,type:"speech",bubbleStyle:"normal",position:{x:50,y:20},size:{width:200,height:80},fontSize:"medium"}]:[],sfx:[],mood:"",lighting:"natural",visualPrompt:I,status:"pending"};await t(m.id,L)}await h(s),x({message:`${T.panels.length}ê°œ íŒ¨ë„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`,type:"success"})}catch(n){console.error("Panel generation failed:",n),x({message:"íŒ¨ë„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",type:"error"})}finally{E(!1)}}},S=async n=>{l&&(await d(l,n),i(null),x({message:"íŒ¨ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤",type:"success"}))},O=async()=>{if(m){for(const n of m.panels)await d(m.id,n.id);i(null),x({message:"ëª¨ë“  íŒ¨ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤",type:"success"})}};return k?e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsx(pe,{size:"lg"})}):r?e.jsxs("div",{className:"min-h-screen bg-gray-900 flex flex-col",children:[e.jsx(Ye,{projectTitle:r.title,episodeTitle:(m==null?void 0:m.title)||"ì—í”¼ì†Œë“œ ì„ íƒ",onSave:()=>x({message:"ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤",type:"success"}),onPreview:()=>c(`/preview/${s}`),onExport:()=>x({message:"ë‚´ë³´ë‚´ê¸° ì¤€ë¹„ ì¤‘...",type:"info"})}),e.jsxs("div",{className:"flex-1 flex",children:[e.jsxs("div",{className:"w-64 bg-gray-800/50 border-r border-gray-700 p-4 overflow-y-auto",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"ì—í”¼ì†Œë“œ"}),e.jsx("div",{className:"space-y-2",children:r.episodes.length>0?r.episodes.map(n=>e.jsxs(P.button,{whileHover:{x:4},onClick:()=>{p(n.id),n.panels.length>0&&i(n.panels[0].id)},className:`w-full text-left p-3 rounded-lg transition-colors ${l===n.id?"bg-purple-600/30 border border-purple-500":"bg-gray-700/50 hover:bg-gray-700"}`,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-white font-medium",children:[n.episodeNumber,"í™”"]}),e.jsxs("span",{className:"text-gray-400 text-sm",children:[n.panels.length," íŒ¨ë„"]})]}),e.jsx("p",{className:"text-gray-400 text-sm truncate mt-1",children:n.title})]},n.id)):e.jsxs("div",{className:"text-center text-gray-400 py-8",children:[e.jsx("p",{children:"ì—í”¼ì†Œë“œê°€ ì—†ìŠµë‹ˆë‹¤"}),e.jsx(A,{variant:"ghost",size:"sm",className:"mt-2",onClick:()=>{},children:"ì—í”¼ì†Œë“œ ì¶”ê°€"})]})}),e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"ìºë¦­í„°"}),e.jsx("div",{className:"space-y-2",children:r.characters.map(n=>e.jsxs("div",{className:"flex items-center gap-3 p-2 rounded-lg bg-gray-700/30",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-sm",children:n.gender==="female"?"ğŸ‘©":"ğŸ‘¨"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white text-sm font-medium",children:n.name}),e.jsx("p",{className:"text-gray-400 text-xs",children:n.role})]})]},n.id))})]})]}),e.jsx("div",{className:"flex-1 flex flex-col p-4 overflow-hidden",children:m?e.jsxs(e.Fragment,{children:[e.jsx(Be,{panels:m.panels,selectedPanelId:a,onSelectPanel:i,onDeletePanel:S,onDeleteAllPanels:O}),e.jsx("div",{className:"flex-1 mt-4 overflow-y-auto",children:b?e.jsx(Ke,{panel:b,episodeId:m.id,onUpdate:n=>u(b.id,n)}):e.jsx(Z,{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-4xl mb-4 block",children:"ğŸ¬"}),e.jsx("p",{className:"text-gray-400 mb-2",children:m.panels.length===0?"ì´ ì—í”¼ì†Œë“œì— íŒ¨ë„ì´ ì—†ìŠµë‹ˆë‹¤":"íŒ¨ë„ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ì¶”ê°€í•˜ì„¸ìš”"}),m.panels.length===0&&e.jsx("p",{className:"text-gray-500 text-sm mb-4",children:"AIê°€ ì—í”¼ì†Œë“œ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ íŒ¨ë„ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤"}),e.jsx(A,{variant:"primary",className:"mt-4",onClick:C,disabled:$,loading:$,children:$?"AI íŒ¨ë„ ìƒì„± ì¤‘...":"AI íŒ¨ë„ ìë™ ìƒì„±"})]})})})]}):e.jsx(Z,{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"text-4xl mb-4 block",children:"ğŸ“š"}),e.jsx("p",{className:"text-gray-400",children:"ì—í”¼ì†Œë“œë¥¼ ì„ íƒí•˜ì„¸ìš”"})]})})}),e.jsxs("div",{className:"w-72 bg-gray-800/50 border-l border-gray-700 p-4 overflow-y-auto",children:[e.jsx(fe,{tabs:[{id:"properties",label:"ì†ì„±"},{id:"dialogue",label:"ëŒ€ì‚¬"}],activeTab:"properties",onChange:()=>{},variant:"underline",fullWidth:!0}),e.jsx("div",{className:"mt-4",children:b?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"íŒ¨ë„ í¬ê¸°"}),e.jsx("p",{className:"text-white",children:b.size})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"ì¹´ë©”ë¼ ì•µê¸€"}),e.jsx("p",{className:"text-white",children:b.cameraAngle})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"ë¶„ìœ„ê¸°"}),e.jsx("p",{className:"text-white",children:b.mood})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-1",children:"ì¡°ëª…"}),e.jsx("p",{className:"text-white",children:b.lighting})]}),b.dialogues.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-400 mb-2",children:"ëŒ€ì‚¬"}),e.jsx("div",{className:"space-y-2",children:b.dialogues.map(n=>e.jsxs("div",{className:"bg-gray-700/50 rounded-lg p-2",children:[e.jsx("p",{className:"text-xs text-purple-400",children:n.characterName||"ë‚˜ë ˆì´ì…˜"}),e.jsx("p",{className:"text-white text-sm",children:n.text})]},n.id))})]})]}):e.jsx("p",{className:"text-gray-400 text-center",children:"íŒ¨ë„ì„ ì„ íƒí•˜ì„¸ìš”"})})]})]})]}):e.jsx("div",{className:"min-h-screen bg-gray-900 flex items-center justify-center",children:e.jsxs(Z,{className:"text-center p-8",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4",children:"í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"}),e.jsx(A,{variant:"primary",onClick:()=>c("/dashboard"),children:"ëŒ€ì‹œë³´ë“œë¡œ ì´ë™"})]})})};export{Ze as default};
